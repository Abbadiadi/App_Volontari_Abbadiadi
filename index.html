<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Volontari</title>
    
    <!-- Google Fonts: Quicksand e Lato -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@700&family=Lato:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Icone (Boxicons) -->
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>

    <style>
        /*------------------------------------*\
          #VARIABILI E TEMA
        \*------------------------------------*/
        :root {
            --font-family-headings: 'Quicksand', sans-serif;
            --font-family-body: 'Lato', sans-serif;

            /* Colori Tema Scuro (Moderno) */
            --bg-color: #001824;
            --card-bg-color: #002a3a;
            --text-color: #f0f6f8;
            --heading-color: #ffffff;
            --primary-accent-color: #cda434; /* Oro */
            --secondary-accent-color: #17a2b8; /* Azzurro */
            --border-color: #004055;
            --shadow-color: rgba(0, 0, 0, 0.5);
            --danger-color: #e74c3c;
            --success-color: #2ecc71;
            --disabled-color: #5f7a85;
            --ongoing-color: var(--success-color);
            --general-event-color: #8854d0; /* Viola per eventi generali */

            /* Colori Sport */
            --sport-velocita: #f39c12;
            --sport-maratonina: #3498db;
            --sport-staffetta: #2ecc71;
            --sport-tiro-al-bersaglio---nerf: #e74c3c;
            --sport-lancio-del-vortex: #9b59b6;
            --sport-kan-jam-frisbee: #1abc9c;
            --sport-salto-in-lungo: #e67e22;
            --sport-calci-di-rigore: #27ae60;
            --sport-bocce-curling: #34495e;
            --sport-tiri-liberi-basket: #d35400;
        }

        body.light-theme {
            /* Colori Tema Chiaro (Moderno) */
            --bg-color: #f8f9fa;
            --card-bg-color: #ffffff;
            --text-color: #212529;
            --heading-color: #112d37;
            --primary-accent-color: #b8860b;
            --secondary-accent-color: #17a2b8;
            --border-color: #dee2e6;
            --shadow-color: rgba(0, 0, 0, 0.1);
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(46, 204, 113, 0); }
            100% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0); }
        }

        /*------------------------------------*\
          #RESET E STILI GLOBALI
        \*------------------------------------*/
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family-body);
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.7;
            transition: background-color 0.3s, color 0.3s;
            overflow-x: hidden;
        }

        h1, h2, h3, h4 {
            font-family: var(--font-family-headings);
            color: var(--heading-color);
            font-weight: 700;
        }

        .hidden { display: none !important; }

        /*------------------------------------*\
          #LAYOUT PRINCIPALE
        \*------------------------------------*/
        #app-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        
        #login-view {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            padding: 1rem;
        }

        #app-view {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        header.app-header {
            background-color: var(--card-bg-color);
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 15px var(--shadow-color);
            z-index: 100;
        }
        
        header.app-header h1 {
            font-size: 1.5rem;
            color: var(--primary-accent-color);
        }

        header.app-header .header-icons i {
            font-size: 1.8rem;
            margin-left: 1rem;
            cursor: pointer;
            transition: color 0.2s;
        }
        header.app-header .header-icons i:hover {
            color: var(--primary-accent-color);
        }

        main#content-area {
            flex-grow: 1;
            padding: 1.5rem;
            overflow-y: auto;
            padding-bottom: 90px; /* Spazio per la nav bar flottante */
        }

        /* Navigazione a Pillola Flottante */
        nav.bottom-nav {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: auto;
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            background-color: var(--card-bg-color);
            padding: 0.7rem;
            border-radius: 50px;
            box-shadow: 0 8px 25px var(--shadow-color);
            z-index: 100;
            border: 1px solid var(--border-color);
        }
        
        .nav-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-color);
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.5rem 1rem;
            border-radius: 30px;
            transition: background-color 0.3s, color 0.3s;
            min-width: 80px;
        }

        .nav-button i {
            font-size: 1.5rem;
            margin-bottom: 0.2rem;
        }
        
        .nav-button span {
            font-size: 0.75rem;
        }

        .nav-button.active {
            color: var(--primary-accent-color);
            background-color: rgba(0,0,0,0.15);
        }

        body.light-theme .nav-button.active {
            color: var(--primary-accent-color);
            background-color: rgba(0,0,0,0.05);
        }

        /*------------------------------------*\
          #COMPONENTI
        \*------------------------------------*/

        /* Login Card */
        #login-card {
            background-color: var(--card-bg-color);
            padding: 2.5rem 2rem;
            border-radius: 28px;
            box-shadow: 0 10px 30px var(--shadow-color);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        #login-card .login-icon {
            font-size: 4rem;
            color: var(--secondary-accent-color);
            margin-bottom: 1rem;
        }
        #login-card h2 {
            margin-bottom: 1.5rem;
            color: var(--heading-color);
        }
        #login-error {
            color: var(--danger-color);
            margin-top: 1rem;
            font-size: 0.9rem;
            min-height: 20px;
        }

        /* Card dei Turni */
        .shift-card {
            background-color: var(--card-bg-color);
            border-radius: 16px;
            margin-bottom: 1rem;
            overflow: hidden;
            box-shadow: 0 5px 20px var(--shadow-color);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }
        
        .shift-header {
            padding: 1rem 1.5rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
        }

        .shift-header h3 {
            font-size: 1.1rem;
            color: white;
        }

        .shift-header .time-info {
            font-size: 0.9rem;
            font-weight: bold;
            color: white;
        }

        .shift-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out, padding 0.5s ease;
            padding: 0 1.5rem;
        }
        .shift-details.expanded {
            max-height: 500px;
            padding: 1rem 1.5rem;
        }
        .shift-details p {
            margin-bottom: 0.5rem;
        }
        .shift-details p strong {
            color: var(--secondary-accent-color);
            margin-right: 0.5rem;
        }
        .shift-card.past {
            opacity: 0.6;
        }

        /* Modali */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background: var(--card-bg-color);
            padding: 2rem;
            border-radius: 28px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px var(--shadow-color);
            transform: scale(0.9);
            transition: transform 0.3s;
        }

        .modal-overlay.visible .modal-content {
            transform: scale(1);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 1rem;
        }
        .modal-header h2 { color: var(--primary-accent-color); }
        .modal-close-btn {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 2rem;
            cursor: pointer;
        }

        /* Form */
        .form-group {
            margin-bottom: 1rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 0.8rem 1rem;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            background-color: var(--bg-color);
            color: var(--text-color);
            font-size: 1rem;
        }
        
        .btn {
            padding: 0.8rem 1.5rem;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            font-family: var(--font-family-body);
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            position: relative;
            min-height: 48px;
        }

        .btn-loader {
            font-size: 1.5rem;
        }
        
        .btn-primary {
            background-color: var(--primary-accent-color);
            color: #001f2b;
        }
        .btn-primary:hover {
            opacity: 0.9;
            box-shadow: 0 4px 15px rgba(205, 164, 52, 0.3);
        }

        .btn-secondary {
            background-color: var(--secondary-accent-color);
            color: #ffffff;
        }
        .btn-danger {
            background-color: var(--danger-color);
            color: #ffffff;
        }
        .btn-block {
            width: 100%;
            margin-top: 1rem;
        }

        /* Interruttore Tema */
        .theme-switcher {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        .switch input { display: none; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 26px; width: 26px;
            left: 4px; bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider { background-color: var(--primary-accent-color); }
        input:checked + .slider:before { transform: translateX(26px); }

        /* Pannello Admin */
        .admin-section { margin-bottom: 2rem; }
        .admin-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--primary-accent-color);
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        /* Lista Volontari */
        .volunteer-item {
            background: var(--card-bg-color);
            border-radius: 16px;
            margin-bottom: 0.5rem;
            border-left: 5px solid var(--secondary-accent-color);
        }
        .volunteer-summary {
            padding: 0.8rem 1.2rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .volunteer-details {
            display: none;
            padding: 1rem 1.2rem;
            border-top: 1px solid var(--border-color);
        }
        .volunteer-details.expanded { display: block; }
        .volunteer-details p { margin-bottom: 0.5rem; }
        .volunteer-actions {
            margin-top: 1rem;
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        /* Sezione Categorie nel Modale */
        .category-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.8rem;
            border-bottom: 1px solid var(--border-color);
        }
        .category-item:last-child {
            border-bottom: none;
        }
        #add-category-form {
            display: flex;
            gap: 0.5rem;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border-color);
        }
        #add-category-form input {
            flex-grow: 1;
        }
        
        /* Fisarmonica Turni Admin */
        .accordion-item {
            border-radius: 16px;
            overflow: hidden;
            margin-bottom: 1rem;
            background: var(--card-bg-color);
            border-left: 5px solid var(--primary-accent-color);
        }
        .accordion-header {
            background-color: transparent;
            padding: 1rem 1.5rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .accordion-body {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-out;
            border-top: 1px solid var(--border-color);
        }
        .accordion-body.show {
            max-height: 1500px;
        }
        
        /* Stile nuovo per i turni nel pannello admin */
        .shift-admin-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
        }
        .shift-admin-item:not(:last-child) {
            border-bottom: 1px solid var(--border-color);
        }
        .shift-admin-info h4 {
            font-family: var(--font-family-body);
            font-weight: bold;
            font-size: 1.1rem;
            margin: 0 0 0.25rem 0;
            color: var(--heading-color);
        }
        .shift-admin-info p {
            font-size: 0.9rem;
            color: var(--text-color);
            opacity: 0.8;
            margin: 0;
        }
        .shift-admin-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        /* Programma Gare */
        #race-program-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }
        @media (min-width: 768px) {
            #race-program-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        .race-program-section {
            margin-bottom: 1rem;
        }
        .race-program-section h3 {
            border-bottom: 2px solid var(--secondary-accent-color);
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .race-event-card {
            background-color: var(--card-bg-color);
            border-radius: 16px;
            margin-bottom: 1rem;
            box-shadow: 0 5px 20px var(--shadow-color);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            overflow: hidden;
        }
        .race-event-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px var(--shadow-color);
        }

        .race-event-header {
            padding: 0.75rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            color: white;
        }
        .race-event-header img {
            width: 30px;
            height: 30px;
            border-radius: 50%;
        }
        .race-event-header h4 {
            color: white;
            flex-grow: 1;
        }
        
        .type-generale .race-event-header { background-color: var(--general-event-color); }
        .sport-velocita .race-event-header { background-color: var(--sport-velocita); }
        .sport-maratonina .race-event-header { background-color: var(--sport-maratonina); }
        .sport-staffetta .race-event-header { background-color: var(--sport-staffetta); }
        .sport-tiro-al-bersaglio---nerf .race-event-header { background-color: var(--sport-tiro-al-bersaglio-nerf); }
        .sport-lancio-del-vortex .race-event-header { background-color: var(--sport-lancio-del-vortex); }
        .sport-kan-jam-frisbee .race-event-header { background-color: var(--sport-kan-jam-frisbee); }
        .sport-salto-in-lungo .race-event-header { background-color: var(--sport-salto-in-lungo); }
        .sport-calci-di-rigore .race-event-header { background-color: var(--sport-calci-di-rigore); }
        .sport-bocce-curling .race-event-header { background-color: var(--sport-bocce-curling); }
        .sport-tiri-liberi-basket .race-event-header { background-color: var(--sport-tiri-liberi-basket); }
        
        .race-event-card.ongoing .race-event-header {
            background-color: var(--ongoing-color);
            animation: pulse 2s infinite;
        }
        
        .race-event-body {
            padding: 1rem 1.5rem;
        }
        
        .race-event-body-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .race-event-card.past {
            opacity: 0.6;
        }
        .race-event-info p {
            margin: 0;
            line-height: 1.4;
        }
        .race-event-info .event-time {
            font-weight: bold;
            color: var(--secondary-accent-color);
        }
        .race-event-actions {
            display: flex;
            gap: 0.5rem;
        }

        .level-tag {
            font-size: 0.75rem;
            font-weight: bold;
            padding: 0.2rem 0.6rem;
            border-radius: 20px;
            color: #fff;
            margin-left: 0.5rem;
            vertical-align: middle;
        }
        .level-generale { background-color: #6c757d; }
        .level-mini { background-color: #17a2b8; }
        .level-junior { background-color: #fd7e14; }
        .level-senior { background-color: #dc3545; }
        
        .progress-bar-container {
            width: 100%;
            height: 8px;
            background-color: var(--border-color);
            border-radius: 8px;
            overflow: hidden;
            margin-top: 1rem;
        }
        .progress-bar {
            height: 100%;
            background-color: var(--ongoing-color);
            border-radius: 8px;
            transition: width 0.5s ease;
        }


        /* Notifiche Toast */
        #toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
        }
        .toast {
            background-color: var(--card-bg-color);
            color: var(--text-color);
            padding: 1rem 1.5rem;
            border-radius: 12px;
            margin-bottom: 1rem;
            box-shadow: 0 4px 15px var(--shadow-color);
            opacity: 0;
            transition: opacity 0.5s, transform 0.5s;
            transform: translateX(100%);
        }
        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }
        .toast.success { border-left: 5px solid var(--success-color); }
        .toast.error { border-left: 5px solid var(--danger-color); }

    </style>
</head>

<body>
    <div id="app-container">
        <!-- VISTA LOGIN -->
        <div id="login-view">
            <div id="login-card">
                <i class='bx bx-user-circle login-icon'></i>
                <h2>Gestione Volontari</h2>
                <form id="login-form">
                    <div class="form-group">
                        <input type="email" id="email-input" placeholder="La tua email" required>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block" id="login-button">
                        <span class="btn-text">Accedi</span>
                        <i class='bx bx-loader-alt bx-spin btn-loader hidden'></i>
                    </button>
                    <p id="login-error">&nbsp;</p>
                </form>
            </div>
        </div>

        <!-- VISTA APPLICAZIONE -->
        <div id="app-view" class="hidden">
            <header class="app-header">
                <h1 id="header-title">I Miei Turni</h1>
                <div class="header-icons">
                    <i class='bx bx-user' id="profile-btn"></i>
                    <!-- <i class='bx bx-bell' id="notifications-btn"></i> -->
                </div>
            </header>

            <main id="content-area">
                <!-- Il contenuto delle viste verrà iniettato qui -->
            </main>

            <nav class="bottom-nav">
                <button class="nav-button active" data-view="my-shifts">
                    <i class='bx bx-calendar-check'></i>
                    <span>I Miei Turni</span>
                </button>
                <button class="nav-button" data-view="race-program">
                    <i class='bx bx-flag'></i>
                    <span>Programma</span>
                </button>
                <button class="nav-button" data-view="admin-panel" id="admin-nav-button">
                    <i class='bx bx-shield-quarter'></i>
                    <span>Admin</span>
                </button>
            </nav>
        </div>
    </div>
    
    <!-- MODALI -->
    <div id="modal-container"></div>
    
    <!-- NOTIFICHE TOAST -->
    <div id="toast-container"></div>


    <!-- Firebase SDKs -->
    <script type="module">
        // Importa le funzioni necessarie dai vari SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            doc, 
            getDoc, 
            getDocs, 
            setDoc,
            addDoc,
            deleteDoc,
            query,
            where,
            onSnapshot,
            writeBatch,
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-firestore.js";

        // ********************************************************************
        // ** CONFIGURAZIONE FIREBASE
        // ********************************************************************
        const firebaseConfig = {
            apiKey: "AIzaSyA3yyNPkWWqWxkj9VGR391bnLyrSr-wTg4",
            authDomain: "gestione-volontari-evento.firebaseapp.com",
            projectId: "gestione-volontari-evento",
            storageBucket: "gestione-volontari-evento.appspot.com",
            messagingSenderId: "507852528635",
            appId: "1:507852528635:web:d6de64b7c45b943892895e",
            measurementId: "G-Z2B36R1WXR"
        };

        // Inizializza Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Riferimenti alle collezioni
        const volunteersCol = collection(db, "volunteers");
        const shiftsCol = collection(db, "shifts");
        const assignmentsCol = collection(db, "assignments");
        const categoriesCol = collection(db, "shift_categories");
        const raceEventsCol = collection(db, "race_events");

        // Stato dell'applicazione
        const AppState = {
            currentUser: null,
            volunteers: [],
            shifts: [],
            assignments: [],
            shiftCategories: [],
            raceEvents: [],
            currentView: 'my-shifts',
            progressInterval: null
        };

        // Elementi DOM principali
        const loginView = document.getElementById('login-view');
        const appView = document.getElementById('app-view');
        const loginForm = document.getElementById('login-form');
        const emailInput = document.getElementById('email-input');
        const loginError = document.getElementById('login-error');
        const contentArea = document.getElementById('content-area');
        const headerTitle = document.getElementById('header-title');
        const navButtons = document.querySelectorAll('.nav-button');
        const adminNavButton = document.getElementById('admin-nav-button');
        const profileBtn = document.getElementById('profile-btn');
        const modalContainer = document.getElementById('modal-container');
        const toastContainer = document.getElementById('toast-container');
        
        const SPORT_DETAILS = {
            'Velocità': { logoUrl: 'https://placehold.co/40x40/f39c12/ffffff?text=V', colorClass: 'sport-velocita' },
            'Maratonina': { logoUrl: 'https://placehold.co/40x40/3498db/ffffff?text=M', colorClass: 'sport-maratonina' },
            'Staffetta': { logoUrl: 'https://placehold.co/40x40/2ecc71/ffffff?text=S', colorClass: 'sport-staffetta' },
            'Tiro al bersaglio - Nerf': { logoUrl: 'https://placehold.co/40x40/e74c3c/ffffff?text=T', colorClass: 'sport-tiro-al-bersaglio---nerf' },
            'Lancio del vortex': { logoUrl: 'https://placehold.co/40x40/9b59b6/ffffff?text=L', colorClass: 'sport-lancio-del-vortex' },
            'Kan-jam frisbee': { logoUrl: 'https://placehold.co/40x40/1abc9c/ffffff?text=K', colorClass: 'sport-kan-jam-frisbee' },
            'Salto in lungo': { logoUrl: 'https://placehold.co/40x40/e67e22/ffffff?text=S', colorClass: 'sport-salto-in-lungo' },
            'Calci di rigore': { logoUrl: 'https://placehold.co/40x40/27ae60/ffffff?text=C', colorClass: 'sport-calci-di-rigore' },
            'Bocce curling': { logoUrl: 'https://placehold.co/40x40/34495e/ffffff?text=B', colorClass: 'sport-bocce-curling' },
            'Tiri liberi basket': { logoUrl: 'https://placehold.co/40x40/d35400/ffffff?text=B', colorClass: 'sport-tiri-liberi-basket' }
        };


        // ====================================================================
        // FUNZIONI DI UTILITY
        // ====================================================================
        
        /**
         * Mostra una notifica "toast".
         * @param {string} message - Il messaggio da mostrare.
         * @param {string} type - 'success' o 'error'.
         */
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            toastContainer.appendChild(toast);

            setTimeout(() => {
                toast.classList.add('show');
            }, 100);

            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    toast.remove();
                }, 500);
            }, 3000);
        }

        /**
         * Mostra o nasconde il loader globale (se implementato)
         * @param {boolean} show - True per mostrare, false per nascondere.
         */
        function toggleLoader(show) {
            // Implementazione loader (es. un overlay) se necessario
            console.log(`Loader: ${show}`);
        }

        /**
         * Pulisce e renderizza un modale.
         * @param {string} title - Titolo del modale.
         * @param {string} contentHtml - HTML del corpo del modale.
         * @param {function} onOpen - Callback eseguita dopo l'apertura.
         */
        function renderModal(title, contentHtml, onOpen = () => {}) {
            modalContainer.innerHTML = `
                <div class="modal-overlay">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2>${title}</h2>
                            <button class="modal-close-btn">&times;</button>
                        </div>
                        <div class="modal-body">
                            ${contentHtml}
                        </div>
                    </div>
                </div>
            `;
            const modalOverlay = modalContainer.querySelector('.modal-overlay');
            const closeBtn = modalContainer.querySelector('.modal-close-btn');

            // Mostra il modale
            setTimeout(() => modalOverlay.classList.add('visible'), 10);

            // Funzione per chiudere
            const closeModal = () => {
                modalOverlay.classList.remove('visible');
                setTimeout(() => { modalContainer.innerHTML = ''; }, 300);
            };

            closeBtn.addEventListener('click', closeModal);
            modalOverlay.addEventListener('click', (e) => {
                if (e.target === modalOverlay) {
                    closeModal();
                }
            });
            
            // Aggiunge un helper globale per chiudere il modale da altre funzioni
            window.closeCurrentModal = closeModal;
            
            if (onOpen) onOpen();
        }

        /**
         * Applica il tema salvato (chiaro/scuro).
         */
        function applyTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.body.classList.toggle('light-theme', savedTheme === 'light');
        }

        /**
         * Converte una stringa in un nome di classe CSS valido.
         * @param {string} text - Il testo da convertire.
         * @returns {string} - Il nome della classe CSS.
         */
        function toCssClass(text) {
            if (!text) return '';
            return text.toLowerCase().replace(/[^a-z0-9]/g, '-').replace(/-+/g, '-');
        }
        
        /**
         * Calcola la progressione di un evento/turno in percentuale.
         * @param {string} dateStr - La data in formato "GG/MM/AAAA".
         * @param {string} startTimeStr - L'ora di inizio in formato "HH:MM".
         * @param {string} endTimeStr - L'ora di fine in formato "HH:MM".
         * @returns {number} - La percentuale di completamento.
         */
        function calculateProgress(dateStr, startTimeStr, endTimeStr) {
            const now = new Date();
            const start = new Date(`${dateStr.split('/').reverse().join('-')}T${startTimeStr}`);
            const end = new Date(`${dateStr.split('/').reverse().join('-')}T${endTimeStr}`);

            if (now < start || now > end) return 0;
            
            const totalDuration = end.getTime() - start.getTime();
            if (totalDuration === 0) return 100;

            const elapsedTime = now.getTime() - start.getTime();
            
            return Math.min(100, (elapsedTime / totalDuration) * 100);
        }
        
        /**
         * Aggiorna tutte le barre di progresso visibili.
         */
        function updateProgressBars() {
            document.querySelectorAll('.progress-bar-container[data-start-time]').forEach(container => {
                const date = container.dataset.date;
                const startTime = container.dataset.startTime;
                const endTime = container.dataset.endTime;
                const progress = calculateProgress(date, startTime, endTime);
                container.querySelector('.progress-bar').style.width = `${progress}%`;
            });
        }


        // ====================================================================
        // FUNZIONI DI AUTENTICAZIONE E SESSIONE
        // ====================================================================
        
        /**
         * Controlla la sessione all'avvio dell'app.
         */
        async function checkSession() {
            toggleLoader(true);
            const userEmail = localStorage.getItem('userEmail');
            
            try {
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Errore di login anonimo:", error);
                loginError.textContent = "Errore di connessione a Firebase.";
                toggleLoader(false);
                showLoginView();
                return;
            }

            if (userEmail) {
                try {
                    const userDoc = await getDoc(doc(db, 'volunteers', userEmail));
                    if (userDoc.exists()) {
                        AppState.currentUser = { id: userDoc.id, ...userDoc.data() };
                        initializeAppUI();
                    } else {
                        // L'utente salvato non esiste più, pulisce la sessione
                        localStorage.removeItem('userEmail');
                        showLoginView();
                    }
                } catch (error) {
                     console.error("Errore controllo sessione:", error);
                     if (error.code === 'permission-denied') {
                        loginError.innerHTML = `Errore di permessi. Controlla le <a href="https://console.firebase.google.com/project/${firebaseConfig.projectId}/firestore/rules" target="_blank" style="color: var(--secondary-accent-color);">regole di sicurezza</a> in Firebase.`;
                     } else {
                        loginError.textContent = 'Errore di connessione nel controllo sessione.';
                     }
                     showLoginView(); // Mostra la vista di login in caso di errore
                }
            } else {
                showLoginView();
            }
            toggleLoader(false);
        }

        /**
         * Gestisce il login dell'utente.
         * @param {Event} e - L'evento del form.
         */
        async function handleLogin(e) {
            e.preventDefault();
            const loginButton = document.getElementById('login-button');
            const buttonText = loginButton.querySelector('.btn-text');
            const buttonLoader = loginButton.querySelector('.btn-loader');
            
            loginButton.disabled = true;
            buttonText.classList.add('hidden');
            buttonLoader.classList.remove('hidden');

            const email = emailInput.value.trim().toLowerCase();
            loginError.textContent = '\u00A0';

            try {
                const userDoc = await getDoc(doc(db, 'volunteers', email));
                if (userDoc.exists()) {
                    AppState.currentUser = { id: userDoc.id, ...userDoc.data() };
                    localStorage.setItem('userEmail', email);
                    initializeAppUI();
                } else {
                    loginError.textContent = 'Email non trovata. Contatta un responsabile.';
                }
            } catch (error) {
                console.error("Errore durante il login:", error);
                if (error.code === 'permission-denied') {
                    loginError.innerHTML = `Errore di permessi. Assicurati di aver impostato le <a href="https://console.firebase.google.com/project/${firebaseConfig.projectId}/firestore/rules" target="_blank" style="color: var(--secondary-accent-color);">regole di sicurezza</a> corrette in Firebase.`;
                } else {
                    loginError.textContent = 'Si è verificato un errore di connessione. Riprova.';
                }
            } finally {
                loginButton.disabled = false;
                buttonText.classList.remove('hidden');
                buttonLoader.classList.add('hidden');
            }
        }
        
        /**
         * Gestisce il logout.
         */
        function handleLogout() {
            localStorage.removeItem('userEmail');
            AppState.currentUser = null;
            if(AppState.progressInterval) clearInterval(AppState.progressInterval);
            window.location.reload(); // Il modo più semplice per resettare lo stato
        }

        // ====================================================================
        // GESTIONE VISTE E UI
        // ====================================================================
        
        /**
         * Mostra la vista di login.
         */
        function showLoginView() {
            loginView.classList.remove('hidden');
            appView.classList.add('hidden');
        }

        /**
         * Inizializza l'interfaccia principale dell'applicazione.
         */
        function initializeAppUI() {
            loginView.classList.add('hidden');
            appView.classList.remove('hidden');
            updateUIBasedOnRole();
            setupEventListeners();
            startRealtimeListeners();
            switchView(AppState.currentView);
            
            // Avvia l'aggiornamento delle progress bar
            if(AppState.progressInterval) clearInterval(AppState.progressInterval);
            AppState.progressInterval = setInterval(updateProgressBars, 60000); // Ogni minuto
        }
        
        /**
         * Aggiorna l'UI in base al ruolo dell'utente.
         */
        function updateUIBasedOnRole() {
            const isAdmin = AppState.currentUser.ruolo === 'Admin' || AppState.currentUser.ruolo === 'Responsabile';
            adminNavButton.style.display = isAdmin ? 'flex' : 'none';
        }

        /**
         * Imposta gli event listener principali dell'app.
         */
        function setupEventListeners() {
            // Gestione navigazione
            navButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const view = button.dataset.view;
                    switchView(view);
                });
            });

            // Gestione profilo
            profileBtn.addEventListener('click', showProfileModal);

            // Delegazione eventi per l'area contenuti
            contentArea.addEventListener('click', e => {
                const shiftHeader = e.target.closest('.shift-header');
                if (shiftHeader) {
                    const details = shiftHeader.nextElementSibling;
                    details.classList.toggle('expanded');
                    return;
                }

                const colleaguesBtn = e.target.closest('.view-colleagues-btn');
                if (colleaguesBtn) {
                    const shiftId = colleaguesBtn.dataset.shiftId;
                    showColleaguesModal(shiftId);
                    return;
                }
            });
        }
        
        /**
         * Cambia la vista attiva.
         * @param {string} viewName - Il nome della vista da mostrare.
         */
        function switchView(viewName) {
            AppState.currentView = viewName;

            navButtons.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === viewName);
            });

            switch (viewName) {
                case 'my-shifts':
                    headerTitle.textContent = "I Miei Turni";
                    renderMyShifts();
                    break;
                case 'race-program':
                    headerTitle.textContent = "Programma Gare";
                    renderRaceProgram();
                    break;
                case 'admin-panel':
                    headerTitle.textContent = "Pannello Admin";
                    renderAdminPanel();
                    break;
            }
            updateProgressBars();
        }
        
        /**
         * Avvia i listener di Firestore per gli aggiornamenti in tempo reale.
         */
        function startRealtimeListeners() {
            onSnapshot(volunteersCol, (snapshot) => {
                AppState.volunteers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                AppState.volunteers.sort((a,b) => a.cognome.localeCompare(b.cognome));
                if (AppState.currentView === 'admin-panel') renderAdminPanel();
            });

            onSnapshot(shiftsCol, (snapshot) => {
                AppState.shifts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (AppState.currentView === 'my-shifts') renderMyShifts();
                if (AppState.currentView === 'admin-panel') renderAdminPanel();
            });

            onSnapshot(assignmentsCol, (snapshot) => {
                AppState.assignments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (AppState.currentView === 'my-shifts') renderMyShifts();
                if (AppState.currentView === 'admin-panel') renderAdminPanel();
            });
            
            onSnapshot(categoriesCol, (snapshot) => {
                AppState.shiftCategories = snapshot.docs.map(doc => doc.id).sort();
                if (AppState.currentView === 'admin-panel') {
                    if(document.getElementById('manage-categories-modal-body')){
                        showManageCategoriesModal();
                    }
                    renderAdminPanel();
                }
            });

            onSnapshot(raceEventsCol, (snapshot) => {
                AppState.raceEvents = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if(AppState.currentView === 'race-program') {
                    renderRaceProgram();
                }
            });
        }

        // ====================================================================
        // FUNZIONI DI RENDER VISTE
        // ====================================================================

        /**
         * Renderizza la vista "I Miei Turni".
         */
        function renderMyShifts() {
            const userAssignments = AppState.assignments.filter(a => a.email_volontario === AppState.currentUser.email);
            const myShiftIds = new Set(userAssignments.map(a => a.id_turno));
            const myShifts = AppState.shifts.filter(s => myShiftIds.has(s.id_turno));

            // Ordina i turni per data e ora
            myShifts.sort((a, b) => {
                const dateA = new Date(a.data_inizio.split('/').reverse().join('-') + 'T' + a.ora_inizio);
                const dateB = new Date(b.data_inizio.split('/').reverse().join('-') + 'T' + b.ora_inizio);
                return dateA - dateB;
            });
            
            if (myShifts.length === 0) {
                contentArea.innerHTML = `<p>Non hai ancora turni assegnati.</p>`;
                return;
            }

            contentArea.innerHTML = myShifts.map(shift => {
                const now = new Date();
                const shiftStart = new Date(`${shift.data_inizio.split('/').reverse().join('-')}T${shift.ora_inizio}`);
                const shiftEnd = new Date(`${shift.data_inizio.split('/').reverse().join('-')}T${shift.ora_fine}`);
                const isPast = shiftEnd < now;
                const isOngoing = now >= shiftStart && now <= shiftEnd;
                
                let progressBarHtml = '';
                if(isOngoing){
                    const progress = calculateProgress(shift.data_inizio, shift.ora_inizio, shift.ora_fine);
                    progressBarHtml = `
                        <div class="progress-bar-container" data-date="${shift.data_inizio}" data-start-time="${shift.ora_inizio}" data-end-time="${shift.ora_fine}">
                           <div class="progress-bar" style="width: ${progress}%;"></div>
                        </div>`;
                }

                return `
                    <div class="shift-card ${isPast ? 'past' : ''} ${isOngoing ? 'ongoing' : ''}">
                        <div class="shift-header">
                            <div>
                                <h3>${shift.nome_turno}</h3>
                                <small>${shift.categoria}</small>
                            </div>
                            <span class="time-info">${shift.data_inizio} | ${shift.ora_inizio} - ${shift.ora_fine}</span>
                        </div>
                        <div class="shift-details">
                            <p><strong>Descrizione:</strong> ${shift.descrizione}</p>
                            <p><strong>Luogo:</strong> ${shift.luogo}</p>
                            ${progressBarHtml}
                            <div style="margin-top: 1rem;">
                                <button class="btn btn-secondary view-colleagues-btn" data-shift-id="${shift.id_turno}">
                                    <i class='bx bx-group'></i> Vedi Colleghi
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        /**
         * Renderizza la vista "Programma Gare".
         */
        function renderRaceProgram() {
            const isAdmin = AppState.currentUser.ruolo === 'Admin' || AppState.currentUser.ruolo === 'Responsabile';
            let adminButtonHtml = '';
            if (isAdmin) {
                adminButtonHtml = `
                    <div style="text-align: right; margin-bottom: 1.5rem;">
                        <button class="btn btn-secondary" id="add-race-event-btn"><i class='bx bx-plus'></i>Crea Evento</button>
                    </div>
                `;
            }

            const now = new Date();
            const events = {
                ongoing: [],
                upcoming: [],
                past: []
            };

            AppState.raceEvents.forEach(event => {
                const startDate = new Date(`${event.date.split('/').reverse().join('-')}T${event.startTime}`);
                const endDate = new Date(`${event.date.split('/').reverse().join('-')}T${event.endTime}`);
                
                if (endDate < now) {
                    events.past.push(event);
                } else if (startDate > now) {
                    events.upcoming.push(event);
                } else {
                    events.ongoing.push(event);
                }
            });

            const renderEventList = (eventList) => {
                if(eventList.length === 0) return '<p>Nessun evento in questa categoria.</p>';
                return eventList.sort((a,b) => new Date(`${a.date.split('/').reverse().join('-')}T${a.startTime}`) - new Date(`${b.date.split('/').reverse().join('-')}T${b.startTime}`)).map(event => {
                    let typeClass = `type-${event.tipologia?.toLowerCase() || 'generale'}`;
                    let logoHtml = `<img src="https://placehold.co/40x40/8854d0/ffffff?text=E" alt="Evento Generale">`;
                    
                    if(event.tipologia === 'Sport') {
                        const sportKey = toCssClass(event.eventName);
                        typeClass = `sport-${sportKey}`;
                        const sportDetail = SPORT_DETAILS[event.eventName];
                        logoHtml = sportDetail ? `<img src="${sportDetail.logoUrl}" alt="${event.eventName}">` : `<i class='bx bx-trophy'></i>`;
                    }

                    let progressBarHtml = '';
                    const isOngoing = events.ongoing.includes(event);
                    if(isOngoing){
                        const progress = calculateProgress(event.date, event.startTime, event.endTime);
                        progressBarHtml = `
                         <div class="progress-bar-container" data-date="${event.date}" data-start-time="${event.startTime}" data-end-time="${event.endTime}">
                           <div class="progress-bar" style="width: ${progress}%;"></div>
                         </div>`;
                    }

                    return `<div class="race-event-card ${isOngoing ? 'ongoing' : ''} ${events.past.includes(event) ? 'past' : ''}">
                        <div class="race-event-header ${typeClass}">
                           ${logoHtml}
                           <h4>${event.eventName} <span class="level-tag level-${event.level?.split(' ')[0].toLowerCase() || 'generale'}">${event.level || 'Generale'}</span></h4>
                        </div>
                        <div class="race-event-body">
                           <div class="race-event-body-top">
                               <div class="race-event-info">
                                  <p class="event-time">${event.startTime} - ${event.endTime}</p>
                                  <p>${event.location}</p>
                               </div>
                               ${isAdmin ? `
                               <div class="race-event-actions">
                                   <button class="btn btn-primary edit-race-event-btn" data-id="${event.id}"><i class='bx bx-edit'></i></button>
                                   <button class="btn btn-danger delete-race-event-btn" data-id="${event.id}"><i class='bx bx-trash'></i></button>
                               </div>
                               ` : ''}
                           </div>
                           ${progressBarHtml ? `<div style="padding-top: 1rem;">${progressBarHtml}</div>` : ''}
                        </div>
                    </div>`
                }).join('');
            };

            contentArea.innerHTML = `
                ${adminButtonHtml}
                <div class="race-program-section">
                    <h3><i class='bx bx-play-circle' style="color: var(--ongoing-color);"></i>In Corso</h3>
                    <div id="race-program-container-ongoing">${renderEventList(events.ongoing)}</div>
                </div>
                <div class="race-program-section">
                    <h3><i class='bx bx-time-five' ></i>Prossimi Eventi</h3>
                     <div id="race-program-container-upcoming">${renderEventList(events.upcoming)}</div>
                </div>
                <div class="race-program-section">
                    <h3><i class='bx bx-check-double'></i>Conclusi</h3>
                     <div id="race-program-container-past">${renderEventList(events.past)}</div>
                </div>
            `;
            
            if (isAdmin) {
                document.getElementById('add-race-event-btn').addEventListener('click', () => showRaceEventForm());
                contentArea.querySelectorAll('.edit-race-event-btn').forEach(btn => btn.addEventListener('click', () => showRaceEventForm(btn.dataset.id)));
                contentArea.querySelectorAll('.delete-race-event-btn').forEach(btn => btn.addEventListener('click', () => handleDeleteRaceEvent(btn.dataset.id)));
            }
        }
        
        /**
         * Renderizza il pannello di amministrazione.
         */
        function renderAdminPanel() {
            contentArea.innerHTML = `
                <section class="admin-section" id="admin-volunteers">
                    <div class="admin-section-header">
                        <h2>Volontari</h2>
                        <button class="btn btn-secondary" id="add-volunteer-btn"><i class='bx bx-plus'></i>Aggiungi</button>
                    </div>
                    <div id="volunteers-list"></div>
                </section>
                <section class="admin-section" id="admin-shifts">
                    <div class="admin-section-header">
                        <h2>Turni</h2>
                        <div>
                            <button class="btn" id="manage-categories-btn" style="background-color: var(--border-color);"><i class='bx bx-category'></i> Gestisci Categorie</button>
                            <button class="btn btn-secondary" id="add-shift-main-btn"><i class='bx bx-plus'></i>Crea Turno</button>
                        </div>
                    </div>
                    <div id="shifts-accordion"></div>
                </section>
            `;
            
            renderVolunteersList();
            renderShiftsAccordion();

            // Aggiungi event listener per i pulsanti del pannello
            document.getElementById('add-volunteer-btn').addEventListener('click', () => showVolunteerForm());
            document.getElementById('add-shift-main-btn').addEventListener('click', () => showShiftForm());
            document.getElementById('manage-categories-btn').addEventListener('click', showManageCategoriesModal);
            
            // Listener per espandere volontari
            document.getElementById('volunteers-list').addEventListener('click', e => {
                 const summary = e.target.closest('.volunteer-summary');
                 if (summary) {
                     const details = summary.nextElementSibling;
                     const wasExpanded = details.classList.contains('expanded');
                     // Chiudi tutti gli altri
                     document.querySelectorAll('.volunteer-details.expanded').forEach(el => el.classList.remove('expanded'));
                     // Apri/chiudi quello corrente
                     if (!wasExpanded) details.classList.add('expanded');
                 }
            });
            
            // Listener per fisarmonica turni
            document.getElementById('shifts-accordion').addEventListener('click', e => {
                const header = e.target.closest('.accordion-header');
                if (header) {
                    const body = header.nextElementSibling;
                    body.classList.toggle('show');
                }
            });
        }
        
        function renderVolunteersList() {
            const listContainer = document.getElementById('volunteers-list');
            if (!listContainer) return;
            listContainer.innerHTML = AppState.volunteers.map(v => `
                <div class="volunteer-item" data-id="${v.id}">
                    <div class="volunteer-summary">
                        <span>${v.cognome} ${v.nome}</span>
                        <i class='bx bx-chevron-down'></i>
                    </div>
                    <div class="volunteer-details">
                        <p><strong>Email:</strong> ${v.email}</p>
                        <p><strong>Telefono:</strong> ${v.telefono}</p>
                        <p><strong>Ruolo:</strong> ${v.ruolo}</p>
                        <div class="volunteer-actions">
                           <button class="btn btn-secondary edit-volunteer-btn" data-id="${v.id}">Modifica</button>
                           <button class="btn btn-secondary view-shifts-btn" data-id="${v.id}">Vedi Turni</button>
                        </div>
                    </div>
                </div>
            `).join('');

            // Aggiungi listener per i pulsanti di azione
            listContainer.querySelectorAll('.edit-volunteer-btn').forEach(btn => {
                btn.addEventListener('click', () => showVolunteerForm(btn.dataset.id));
            });
            listContainer.querySelectorAll('.view-shifts-btn').forEach(btn => {
                btn.addEventListener('click', () => showVolunteerShiftsModal(btn.dataset.id));
            });
        }
        
        function renderShiftsAccordion() {
            const accordionContainer = document.getElementById('shifts-accordion');
            if (!accordionContainer) return;

            const shiftsByCategory = AppState.shifts.reduce((acc, shift) => {
                const category = shift.categoria || 'Senza Categoria';
                if (!acc[category]) acc[category] = [];
                acc[category].push(shift);
                return acc;
            }, {});

            accordionContainer.innerHTML = Object.keys(shiftsByCategory).sort().map(category => `
                <div class="accordion-item">
                    <div class="accordion-header">
                        <h3>${category} (${shiftsByCategory[category].length})</h3>
                        <i class='bx bx-chevron-down'></i>
                    </div>
                    <div class="accordion-body">
                        ${shiftsByCategory[category].map(shift => `
                            <div class="shift-admin-item">
                                <div class="shift-admin-info">
                                    <h4>${shift.nome_turno}</h4>
                                    <p>${shift.data_inizio} | ${shift.ora_inizio} - ${shift.ora_fine}</p>
                                </div>
                                <div class="shift-admin-actions">
                                    <button class="btn btn-primary edit-shift-btn" data-id="${shift.id}">Modifica</button>
                                    <button class="btn btn-secondary manage-volunteers-btn" data-id="${shift.id}">Gestisci</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');

            // Aggiungi listener per i pulsanti di azione dentro l'accordion
            accordionContainer.querySelectorAll('.edit-shift-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    showShiftForm(btn.dataset.id);
                });
            });
            accordionContainer.querySelectorAll('.manage-volunteers-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    showManageVolunteersModal(btn.dataset.id);
                });
            });
        }

        // ====================================================================
        // FUNZIONI MODALI E FORM
        // ====================================================================

        function showColleaguesModal(shiftId) {
            const shift = AppState.shifts.find(s => s.id_turno === shiftId);
            if (!shift) return;

            const assignedEmails = AppState.assignments
                .filter(a => a.id_turno === shiftId)
                .map(a => a.email_volontario);
            
            const colleagues = AppState.volunteers
                .filter(v => assignedEmails.includes(v.email) && v.email !== AppState.currentUser.email);

            let contentHtml = '';
            if (colleagues.length > 0) {
                contentHtml = '<ul style="list-style: none; padding: 0;">' + colleagues.map(v => `<li style="padding: 0.5rem 0;">${v.nome} ${v.cognome}</li>`).join('') + '</ul>';
            } else {
                contentHtml = '<p>Sei l\'unico volontario assegnato a questo turno per ora.</p>';
            }

            renderModal(`Colleghi per: ${shift.nome_turno}`, contentHtml);
        }

        function showManageCategoriesModal() {
            let listHtml = '';
            if (AppState.shiftCategories.length === 0) {
                listHtml = `<p>Nessuna categoria creata.</p>`;
            } else {
                listHtml = AppState.shiftCategories.map(cat => `
                    <div class="category-item">
                        <span>${cat}</span>
                        <button class="btn btn-danger delete-category-btn" data-id="${cat}"><i class='bx bx-trash'></i></button>
                    </div>
                `).join('');
            }
            
            const contentHtml = `
                <div id="manage-categories-modal-body">
                    <div id="categories-list-modal">${listHtml}</div>
                    <form id="add-category-form">
                        <input type="text" id="new-category-name" placeholder="Nome nuova categoria" required>
                        <button type="submit" class="btn btn-secondary"><i class='bx bx-plus'></i></button>
                    </form>
                </div>
            `;
            
            renderModal('Gestisci Categorie', contentHtml, () => {
                document.getElementById('add-category-form').addEventListener('submit', handleAddCategory);
                document.querySelectorAll('.delete-category-btn').forEach(btn => {
                    btn.addEventListener('click', () => handleDeleteCategory(btn.dataset.id));
                });
            });
        }

        async function handleAddCategory(e) {
            e.preventDefault();
            const input = document.getElementById('new-category-name');
            const categoryName = input.value.trim();
            if (!categoryName) {
                showToast('Il nome della categoria non può essere vuoto.', 'error');
                return;
            }
            try {
                // Usiamo il nome della categoria come ID del documento per garantirne l'unicità
                await setDoc(doc(db, 'shift_categories', categoryName), {});
                showToast('Categoria aggiunta!');
                input.value = '';
                // Il listener onSnapshot aggiornerà automaticamente la UI del modale
            } catch (error) {
                console.error("Errore aggiunta categoria:", error);
                showToast('Errore durante l\'aggiunta della categoria.', 'error');
            }
        }
        
        async function handleDeleteCategory(categoryId) {
            if (!confirm(`Sei sicuro di voler rimuovere la categoria "${categoryId}"? Questa azione non può essere annullata.`)) return;
            try {
                await deleteDoc(doc(db, 'shift_categories', categoryId));
                showToast('Categoria rimossa.');
                // Il listener onSnapshot aggiornerà automaticamente la UI del modale
            } catch (error) {
                console.error("Errore rimozione categoria:", error);
                showToast('Errore durante la rimozione.', 'error');
            }
        }

        /**
         * Mostra il modale del profilo utente.
         */
        function showProfileModal() {
            const { nome, cognome, email, telefono } = AppState.currentUser;
            const currentTheme = document.body.classList.contains('light-theme') ? 'light' : 'dark';
            
            const content = `
                <p><strong>Nome:</strong> ${nome} ${cognome}</p>
                <p><strong>Email:</strong> ${email}</p>
                <p><strong>Telefono:</strong> ${telefono}</p>
                <hr style="margin: 1.5rem 0; border-color: var(--border-color);">
                <div class="theme-switcher">
                    <span>Tema Chiaro</span>
                    <label class="switch">
                        <input type="checkbox" id="theme-toggle" ${currentTheme === 'light' ? 'checked' : ''}>
                        <span class="slider"></span>
                    </label>
                </div>
                <button id="logout-btn" class="btn btn-danger btn-block">Logout</button>
            `;
            renderModal('Il Mio Profilo', content, () => {
                document.getElementById('logout-btn').addEventListener('click', handleLogout);
                document.getElementById('theme-toggle').addEventListener('change', (e) => {
                    const theme = e.target.checked ? 'light' : 'dark';
                    localStorage.setItem('theme', theme);
                    applyTheme();
                });
            });
        }

        /**
         * Mostra il form per aggiungere/modificare un volontario.
         * @param {string|null} volunteerId - L'ID del volontario da modificare, o null per aggiungerne uno nuovo.
         */
        function showVolunteerForm(volunteerId = null) {
            const isEditing = volunteerId !== null;
            const volunteer = isEditing ? AppState.volunteers.find(v => v.id === volunteerId) : {};
            const title = isEditing ? 'Modifica Volontario' : 'Aggiungi Volontario';

            const formHtml = `
                <form id="volunteer-form">
                    <input type="hidden" id="volunteerId" value="${volunteerId || ''}">
                    <div class="form-group">
                        <label for="nome">Nome</label>
                        <input type="text" id="nome" value="${volunteer.nome || ''}" required>
                    </div>
                    <div class="form-group">
                        <label for="cognome">Cognome</label>
                        <input type="text" id="cognome" value="${volunteer.cognome || ''}" required>
                    </div>
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" value="${volunteer.email || ''}" ${isEditing ? 'readonly' : ''} required>
                    </div>
                    <div class="form-group">
                        <label for="telefono">Telefono</label>
                        <input type="tel" id="telefono" value="${volunteer.telefono || ''}" required>
                    </div>
                    <div class="form-group">
                        <label for="ruolo">Ruolo</label>
                        <select id="ruolo" required>
                            <option value="Volontario" ${volunteer.ruolo === 'Volontario' ? 'selected' : ''}>Volontario</option>
                            <option value="Responsabile" ${volunteer.ruolo === 'Responsabile' ? 'selected' : ''}>Responsabile</option>
                            <option value="Admin" ${volunteer.ruolo === 'Admin' ? 'selected' : ''}>Admin</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">${isEditing ? 'Salva Modifiche' : 'Aggiungi Volontario'}</button>
                    ${isEditing ? '<button type="button" id="delete-volunteer-btn" class="btn btn-danger btn-block">Rimuovi Volontario</button>' : ''}
                </form>
            `;

            renderModal(title, formHtml, () => {
                document.getElementById('volunteer-form').addEventListener('submit', handleVolunteerFormSubmit);
                if (isEditing) {
                    document.getElementById('delete-volunteer-btn').addEventListener('click', () => handleDeleteVolunteer(volunteerId));
                }
            });
        }
        
        async function handleVolunteerFormSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const volunteerId = form.querySelector('#volunteerId').value;
            const isEditing = !!volunteerId;

            const data = {
                nome: form.querySelector('#nome').value,
                cognome: form.querySelector('#cognome').value,
                email: form.querySelector('#email').value.toLowerCase(),
                telefono: form.querySelector('#telefono').value,
                ruolo: form.querySelector('#ruolo').value,
            };

            // Validazione base
            if (!data.nome || !data.cognome || !data.email || !data.telefono) {
                showToast('Tutti i campi sono obbligatori.', 'error');
                return;
            }

            toggleLoader(true);
            try {
                // L'ID del documento è l'email
                const docRef = doc(db, 'volunteers', data.email);
                await setDoc(docRef, data);
                showToast(`Volontario ${isEditing ? 'aggiornato' : 'aggiunto'} con successo!`);
                window.closeCurrentModal();
            } catch (error) {
                console.error("Errore salvataggio volontario:", error);
                showToast('Errore durante il salvataggio.', 'error');
            } finally {
                toggleLoader(false);
            }
        }
        
        async function handleDeleteVolunteer(volunteerId) {
            if (!confirm(`Sei sicuro di voler rimuovere questo volontario? Verranno rimosse anche tutte le sue assegnazioni ai turni.`)) return;

            toggleLoader(true);
            try {
                // Rimuove prima tutte le assegnazioni del volontario
                const q = query(assignmentsCol, where('email_volontario', '==', volunteerId));
                const assignmentsSnapshot = await getDocs(q);
                const batch = writeBatch(db);
                assignmentsSnapshot.forEach(doc => {
                    batch.delete(doc.ref);
                });
                await batch.commit();

                // Rimuove il volontario
                await deleteDoc(doc(db, 'volunteers', volunteerId));
                showToast('Volontario e assegnazioni rimossi.');
                window.closeCurrentModal();
            } catch (error) {
                console.error("Errore rimozione volontario:", error);
                showToast('Errore durante la rimozione.', 'error');
            } finally {
                toggleLoader(false);
            }
        }
        
        function showShiftForm(shiftId = null, category = '') {
            const isEditing = shiftId !== null;
            const shift = isEditing ? AppState.shifts.find(s => s.id === shiftId) : {};
            const title = isEditing ? 'Modifica Turno' : 'Crea Turno';

            const categoryOptions = AppState.shiftCategories.map(cat => {
                const selected = isEditing ? (cat === shift.categoria) : (cat === category);
                return `<option value="${cat}" ${selected ? 'selected' : ''}>${cat}</option>`
            }).join('');

            const formHtml = `
                <form id="shift-form">
                    <input type="hidden" id="shiftId" value="${shiftId || ''}">
                    <div class="form-group">
                        <label for="id_turno">ID Turno (es. ACC-01)</label>
                        <input type="text" id="id_turno" value="${shift.id_turno || ''}" required ${isEditing ? 'readonly' : ''}>
                    </div>
                    <div class="form-group">
                        <label for="categoria">Categoria</label>
                        <select id="categoria" required>
                            <option value="">Seleziona una categoria</option>
                            ${categoryOptions}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="nome_turno">Nome Turno</label>
                        <input type="text" id="nome_turno" value="${shift.nome_turno || ''}" required>
                    </div>
                    <div class="form-group">
                        <label for="descrizione">Descrizione</label>
                        <input type="text" id="descrizione" value="${shift.descrizione || ''}" required>
                    </div>
                    <div class="form-group">
                        <label for="luogo">Luogo</label>
                        <input type="text" id="luogo" value="${shift.luogo || ''}" required>
                    </div>
                    <div class="form-group">
                        <label for="data_inizio">Data (GG/MM/AAAA)</label>
                        <input type="text" id="data_inizio" placeholder="GG/MM/AAAA" value="${shift.data_inizio || ''}" required>
                    </div>
                    <div class="form-group">
                        <label for="ora_inizio">Ora Inizio (HH:MM)</label>
                        <input type="time" id="ora_inizio" value="${shift.ora_inizio || ''}" required>
                    </div>
                    <div class="form-group">
                        <label for="ora_fine">Ora Fine (HH:MM)</label>
                        <input type="time" id="ora_fine" value="${shift.ora_fine || ''}" required>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">${isEditing ? 'Salva Modifiche' : 'Crea Turno'}</button>
                    ${isEditing ? '<button type="button" id="delete-shift-btn" class="btn btn-danger btn-block">Rimuovi Turno</button>' : ''}
                </form>
            `;

            renderModal(title, formHtml, () => {
                document.getElementById('shift-form').addEventListener('submit', handleShiftFormSubmit);
                if (isEditing) {
                    document.getElementById('delete-shift-btn').addEventListener('click', () => handleDeleteShift(shiftId));
                }
            });
        }
        
        async function handleShiftFormSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const shiftId = form.querySelector('#shiftId').value;
            const isEditing = !!shiftId;

            const data = {
                id_turno: form.querySelector('#id_turno').value,
                categoria: form.querySelector('#categoria').value,
                nome_turno: form.querySelector('#nome_turno').value,
                descrizione: form.querySelector('#descrizione').value,
                luogo: form.querySelector('#luogo').value,
                data_inizio: form.querySelector('#data_inizio').value,
                ora_inizio: form.querySelector('#ora_inizio').value,
                ora_fine: form.querySelector('#ora_fine').value,
            };

            if (Object.values(data).some(v => !v)) {
                showToast('Tutti i campi sono obbligatori.', 'error');
                return;
            }

            toggleLoader(true);
            try {
                if(isEditing){
                    await setDoc(doc(db, 'shifts', shiftId), data);
                } else {
                    await setDoc(doc(db, 'shifts', data.id_turno), data);
                }
                showToast(`Turno ${isEditing ? 'aggiornato' : 'creato'} con successo!`);
                window.closeCurrentModal();
            } catch (error) {
                console.error("Errore salvataggio turno:", error);
                showToast('Errore durante il salvataggio.', 'error');
            } finally {
                toggleLoader(false);
            }
        }
        
        async function handleDeleteShift(shiftId) {
             const shiftToDelete = AppState.shifts.find(s => s.id === shiftId);
             if (!shiftToDelete) return;
            
             if (!confirm(`Sei sicuro di voler rimuovere il turno "${shiftToDelete.nome_turno}"? Verranno rimosse anche tutte le sue assegnazioni.`)) return;

            toggleLoader(true);
            try {
                // Rimuove le assegnazioni associate a questo turno
                const q = query(assignmentsCol, where('id_turno', '==', shiftToDelete.id_turno));
                const assignmentsSnapshot = await getDocs(q);
                const batch = writeBatch(db);
                assignmentsSnapshot.forEach(doc => {
                    batch.delete(doc.ref);
                });
                await batch.commit();

                // Rimuove il turno
                await deleteDoc(doc(db, 'shifts', shiftId));
                showToast('Turno e assegnazioni rimossi.');
                window.closeCurrentModal();
            } catch (error) {
                console.error("Errore rimozione turno:", error);
                showToast('Errore durante la rimozione.', 'error');
            } finally {
                toggleLoader(false);
            }
        }

        function showVolunteerShiftsModal(volunteerEmail) {
            const volunteer = AppState.volunteers.find(v => v.email === volunteerEmail);
            const assignments = AppState.assignments.filter(a => a.email_volontario === volunteerEmail);
            const shiftIds = assignments.map(a => a.id_turno);
            const shifts = AppState.shifts.filter(s => shiftIds.includes(s.id_turno));
            
            let contentHtml = '<p>Nessun turno assegnato.</p>';
            if (shifts.length > 0) {
                contentHtml = shifts.map(s => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0;">
                        <span>${s.nome_turno} (${s.data_inizio})</span>
                        <button class="btn btn-danger remove-assignment-btn" data-assignment-id="${assignments.find(a => a.id_turno === s.id_turno).id}"><i class='bx bx-trash'></i></button>
                    </div>
                `).join('');
            }

            renderModal(`Turni di ${volunteer.nome} ${volunteer.cognome}`, contentHtml, () => {
                document.querySelectorAll('.remove-assignment-btn').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        const assignmentId = btn.dataset.assignmentId;
                        if(confirm('Rimuovere questa assegnazione?')){
                            try {
                                await deleteDoc(doc(db, 'assignments', assignmentId));
                                showToast('Assegnazione rimossa.');
                                // Ricarica il modale
                                showVolunteerShiftsModal(volunteerEmail);
                            } catch (error) {
                                showToast('Errore rimozione.', 'error');
                            }
                        }
                    });
                });
            });
        }
        
        function showManageVolunteersModal(shiftId) {
            const shift = AppState.shifts.find(s => s.id === shiftId);
            const assignedVolunteersEmails = new Set(
                AppState.assignments
                    .filter(a => a.id_turno === shift.id_turno)
                    .map(a => a.email_volontario)
            );

            const assignedVolunteers = AppState.volunteers.filter(v => assignedVolunteersEmails.has(v.email));
            const availableVolunteers = AppState.volunteers.filter(v => !assignedVolunteersEmails.has(v.email));

            const contentHtml = `
                <div>
                    <h4>Volontari Assegnati</h4>
                    <div id="assigned-list" style="margin-bottom: 1.5rem;">
                    ${assignedVolunteers.length > 0 ? assignedVolunteers.map(v => `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0;">
                            <span>${v.nome} ${v.cognome}</span>
                            <button class="btn btn-danger unassign-btn" data-email="${v.email}"><i class='bx bx-x'></i></button>
                        </div>
                    `).join('') : '<p>Nessuno</p>'}
                    </div>
                    
                    <h4>Assegna Nuovi Volontari</h4>
                    <form id="assign-form">
                        <div class="form-group">
                        ${availableVolunteers.length > 0 ? availableVolunteers.map(v => `
                            <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.3rem 0;">
                                <input type="checkbox" name="assign-volunteer" value="${v.email}">
                                ${v.nome} ${v.cognome}
                            </label>
                        `).join('') : '<p>Nessun volontario disponibile.</p>'}
                        </div>
                        <button type="submit" class="btn btn-primary btn-block">Assegna Selezionati</button>
                    </form>
                </div>
            `;

            renderModal(`Gestisci Volontari per: ${shift.nome_turno}`, contentHtml, () => {
                // Rimuovi assegnazione
                document.querySelectorAll('.unassign-btn').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        const email = btn.dataset.email;
                        const assignment = AppState.assignments.find(a => a.id_turno === shift.id_turno && a.email_volontario === email);
                        if (assignment) {
                            await deleteDoc(doc(db, 'assignments', assignment.id));
                            showToast('Assegnazione rimossa');
                            showManageVolunteersModal(shiftId); // Ricarica modale
                        }
                    });
                });

                // Aggiungi assegnazioni
                document.getElementById('assign-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const selectedEmails = Array.from(e.target.querySelectorAll('input[name="assign-volunteer"]:checked')).map(cb => cb.value);
                    if (selectedEmails.length === 0) return;

                    try {
                        const batch = writeBatch(db);
                        selectedEmails.forEach(email => {
                            const newAssignmentRef = doc(collection(db, 'assignments'));
                            batch.set(newAssignmentRef, { email_volontario: email, id_turno: shift.id_turno });
                        });
                        await batch.commit();
                        showToast('Volontari assegnati');
                        showManageVolunteersModal(shiftId); // Ricarica modale
                    } catch (error) {
                        showToast('Errore assegnazione', 'error');
                    }
                });
            });
        }
        
        function showRaceEventForm(eventId = null) {
            const isEditing = eventId !== null;
            const event = isEditing ? AppState.raceEvents.find(e => e.id === eventId) : {};
            const title = isEditing ? 'Modifica Evento' : 'Crea Evento Gara';

            const levelOptions = [
                'Generale', 'Mini', 'Mini Maschile', 'Mini Femminile', 
                'Junior', 'Junior Maschile', 'Junior Femminile',
                'Senior', 'Senior Maschile', 'Senior Femminile'
            ].map(level => {
                const selected = isEditing && event.level === level;
                return `<option value="${level}" ${selected ? 'selected' : ''}>${level}</option>`
            }).join('');
            
            const sportOptions = Object.keys(SPORT_DETAILS).map(sport => {
                const selected = isEditing && event.tipologia === 'Sport' && event.eventName === sport;
                return `<option value="${sport}" ${selected ? 'selected' : ''}>${sport}</option>`;
            }).join('');

            const formHtml = `
                <form id="race-event-form">
                    <input type="hidden" id="raceEventId" value="${eventId || ''}">
                    <div class="form-group">
                        <label for="eventType">Tipologia</label>
                        <select id="eventType" required>
                            <option value="">Seleziona tipologia...</option>
                            <option value="Sport" ${isEditing && event.tipologia === 'Sport' ? 'selected' : ''}>Sport</option>
                            <option value="Generale" ${isEditing && event.tipologia === 'Generale' ? 'selected' : ''}>Generale</option>
                        </select>
                    </div>
                    
                    <div id="eventNameSportContainer" class="form-group ${!isEditing || event.tipologia !== 'Sport' ? 'hidden' : ''}">
                        <label for="eventNameSport">Nome Sport</label>
                        <select id="eventNameSport">
                            ${sportOptions}
                        </select>
                    </div>

                    <div id="eventNameGeneralContainer" class="form-group ${!isEditing || event.tipologia !== 'Generale' ? 'hidden' : ''}">
                        <label for="eventNameGeneral">Nome Evento</label>
                        <input type="text" id="eventNameGeneral" value="${isEditing && event.tipologia === 'Generale' ? event.eventName : ''}">
                    </div>

                    <div class="form-group">
                        <label for="level">Livello</label>
                        <select id="level" required>
                            ${levelOptions}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="location">Luogo</label>
                        <input type="text" id="location" value="${event.location || ''}" required>
                    </div>
                     <div class="form-group">
                        <label for="date">Data (GG/MM/AAAA)</label>
                        <input type="text" id="date" placeholder="GG/MM/AAAA" value="${event.date || ''}" required>
                    </div>
                    <div class="form-group">
                        <label for="startTime">Ora Inizio (HH:MM)</label>
                        <input type="time" id="startTime" value="${event.startTime || ''}" required>
                    </div>
                    <div class="form-group">
                        <label for="endTime">Ora Fine (HH:MM)</label>
                        <input type="time" id="endTime" value="${event.endTime || ''}" required>
                    </div>
                    <div class="form-group">
                        <label for="description">Descrizione (opzionale)</label>
                        <input type="text" id="description" value="${event.description || ''}">
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">${isEditing ? 'Salva Modifiche' : 'Crea Evento'}</button>
                </form>
            `;
            renderModal(title, formHtml, () => {
                const eventTypeSelect = document.getElementById('eventType');
                const sportContainer = document.getElementById('eventNameSportContainer');
                const generalContainer = document.getElementById('eventNameGeneralContainer');

                eventTypeSelect.addEventListener('change', () => {
                    sportContainer.classList.toggle('hidden', eventTypeSelect.value !== 'Sport');
                    generalContainer.classList.toggle('hidden', eventTypeSelect.value !== 'Generale');
                });
                
                document.getElementById('race-event-form').addEventListener('submit', handleRaceEventFormSubmit);
            });
        }

        async function handleRaceEventFormSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const eventId = form.querySelector('#raceEventId').value;
            const isEditing = !!eventId;

            const tipologia = form.querySelector('#eventType').value;
            let eventName = '';
            if (tipologia === 'Sport') {
                eventName = form.querySelector('#eventNameSport').value;
            } else if (tipologia === 'Generale') {
                eventName = form.querySelector('#eventNameGeneral').value;
            }

            const data = {
                tipologia: tipologia,
                eventName: eventName,
                level: form.querySelector('#level').value,
                location: form.querySelector('#location').value,
                date: form.querySelector('#date').value,
                startTime: form.querySelector('#startTime').value,
                endTime: form.querySelector('#endTime').value,
                description: form.querySelector('#description').value
            };

            if (!data.tipologia || !data.eventName || !data.location || !data.date || !data.startTime || !data.endTime) {
                showToast('Tutti i campi (tranne descrizione) sono obbligatori.', 'error');
                return;
            }

            try {
                if (isEditing) {
                    await setDoc(doc(db, 'race_events', eventId), data);
                } else {
                    await addDoc(raceEventsCol, data);
                }
                showToast(`Evento ${isEditing ? 'aggiornato' : 'creato'} con successo!`);
                window.closeCurrentModal();
            } catch (error) {
                console.error("Errore salvataggio evento:", error);
                showToast('Errore durante il salvataggio.', 'error');
            }
        }

        async function handleDeleteRaceEvent(eventId) {
            if (!confirm('Sei sicuro di voler eliminare questo evento?')) return;
            try {
                await deleteDoc(doc(db, 'race_events', eventId));
                showToast('Evento eliminato.');
            } catch (error) {
                console.error("Errore eliminazione evento:", error);
                showToast('Errore durante l\'eliminazione.', 'error');
            }
        }


        // ====================================================================
        // INIZIO APPLICAZIONE
        // ====================================================================
        function init() {
            applyTheme();
            loginForm.addEventListener('submit', handleLogin);
            onAuthStateChanged(auth, (user) => {
                if(user) { // Utente anonimo autenticato
                    console.log("Utente anonimo loggato con UID:", user.uid);
                    checkSession(); // Ora controlla la sessione 'logica' dell'app
                }
            });
        }

        init();
    </script>
</body>
</html>
