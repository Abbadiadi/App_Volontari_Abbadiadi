<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Volontari</title>
    
    <!-- PWA Manifest e Meta Tags -->
    <meta name="theme-color" content="#001f2b"/>
    <link rel="manifest" id="manifest">
    
    <!-- Google Fonts: Nunito e Quicksand -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@800;900&family=Quicksand:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Icone (Boxicons) -->
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>

    <style>
        /*------------------------------------*\
          #VARIABILI E TEMA
        \*------------------------------------*/
        :root {
            /* FONT */
            --font-family-headings: 'Nunito', sans-serif;
            --font-family-body: 'Quicksand', sans-serif;

            /* Colori Tema Scuro (Blu Profondo) */
            --bg-color: #001f2b;
            --card-bg-color: #003344;
            --text-color: #eaf4f8;
            --heading-color: #ffffff;
            --primary-accent-color: #cda434; /* Oro */
            --secondary-accent-color: #17a2b8; /* Azzurro */
            --border-color: #004b66;
            --shadow-color: rgba(0, 0, 0, 0.4);
            --danger-color: #e74c3c;
            --success-color: #2ecc71;
            --disabled-color: #5f7a85;
            --ongoing-color: var(--success-color);
            --general-event-color: #8854d0; /* Viola per eventi generali */

            /* Colori Gemini */
            --gemini-blue: #4285F4;
            --gemini-green: #34A853;
            --gemini-red: #EA4335;
            --gemini-yellow: #FBBC05;

            /* Colori Sport */
            --sport-velocita: #f39c12;
            --sport-maratonina: #3498db;
            --sport-staffetta: #2ecc71;
            --sport-tiro-al-bersaglio---nerf: #e74c3c;
            --sport-lancio-del-vortex: #9b59b6;
            --sport-kan-jam-frisbee: #1abc9c;
            --sport-salto-in-lungo: #e67e22;
            --sport-calci-di-rigore: #27ae60;
            --sport-bocce-curling: #34495e;
            --sport-tiri-liberi-basket: #d35400;
        }

        body.light-theme {
            /* Colori Tema Chiaro */
            --bg-color: #f4f6f8;
            --card-bg-color: #ffffff;
            --text-color: #333333;
            --heading-color: #001f2b;
            --primary-accent-color: #b8860b;
            --secondary-accent-color: #17a2b8;
            --border-color: #e0e0e0;
            --shadow-color: rgba(0, 0, 0, 0.1);
        }
        
        @keyframes pulse-border {
            0% { box-shadow: 0 0 0 0px var(--ongoing-color); }
            70% { box-shadow: 0 0 0 12px rgba(46, 204, 113, 0); }
            100% { box-shadow: 0 0 0 0px rgba(46, 204, 113, 0); }
        }

        /*------------------------------------*\
          #RESET E STILI GLOBALI
        \*------------------------------------*/
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-family-body);
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            font-weight: 500;
            transition: background-color 0.3s, color 0.3s;
            overflow-x: hidden;
        }

        h1, h2, h3, h4 {
            font-family: var(--font-family-headings);
            color: var(--heading-color);
            font-weight: 800;
        }

        .hidden { display: none !important; }

        /*------------------------------------*\
          #LAYOUT PRINCIPALE
        \*------------------------------------*/
        #app-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        
        #login-view {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            padding: 1rem;
        }

        #app-view {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        header.app-header {
            background-color: var(--card-bg-color);
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 15px var(--shadow-color);
            z-index: 100;
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.3s, box-shadow 0.3s, border-color 0.3s;
        }
        header.app-header.dashboard-mode {
            background-color: transparent;
            box-shadow: none;
            border-bottom-color: transparent;
        }
        
        header.app-header h1 {
            font-size: 1.8rem;
            color: var(--primary-accent-color);
            font-weight: 900;
        }

        .header-icons {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .header-icons .icon-btn {
            position: relative;
            font-size: 1.8rem;
            cursor: pointer;
            transition: color 0.2s;
        }
        .header-icons .icon-btn:hover {
            color: var(--primary-accent-color);
        }
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -8px;
            background-color: var(--gemini-red);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.7rem;
            font-weight: 700;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 2px solid var(--card-bg-color);
        }

        main#content-area {
            flex-grow: 1;
            padding: 1.5rem;
            overflow-y: auto;
            padding-bottom: 90px;
        }

        /* Navigazione a Pillola Flottante */
        nav.bottom-nav {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: auto;
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            background-color: var(--card-bg-color);
            padding: 0.7rem;
            border-radius: 50px;
            box-shadow: 0 8px 25px var(--shadow-color);
            z-index: 100;
            border: 1px solid var(--border-color);
        }
        
        .nav-button {
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-color);
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.8rem;
            border-radius: 50%;
            transition: background-color 0.3s, color 0.3s;
            width: 60px;
            height: 60px;
        }

        .nav-button i {
            font-size: 1.8rem;
        }
        
        .nav-button.active {
            color: var(--primary-accent-color);
            background-color: rgba(56, 189, 248, 0.1);
        }

        /*------------------------------------*\
          #DASHBOARD
        \*------------------------------------*/
        #dashboard-view {
            padding-top: 0;
        }
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        .dashboard-header .welcome-text h2 {
            font-size: 2.2rem;
            margin: 0;
        }
        .dashboard-header .welcome-text p {
            opacity: 0.8;
            margin-top: 0.25rem;
            font-weight: 500;
        }
        
        .summary-card-container {
            display: flex;
            overflow-x: auto;
            padding-bottom: 1rem;
            margin-bottom: 1.5rem;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .summary-card-container::-webkit-scrollbar {
            display: none;
        }
        
        .summary-card {
            flex: 0 0 220px;
            background: var(--card-bg-color);
            padding: 1rem;
            border-radius: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            border: 1px solid var(--border-color);
            margin-right: 1rem;
            cursor: pointer;
            transition: transform 0.2s ease;
        }
        .summary-card:hover {
            transform: translateY(-4px);
        }
        .summary-card:last-child {
            margin-right: 0;
        }
        
        .summary-card .icon-wrapper {
            font-size: 2rem;
            padding: 0.8rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .summary-card .card-content .value {
            font-family: var(--font-family-headings);
            font-weight: 800;
            font-size: 1.5rem;
            line-height: 1.2;
        }
        .summary-card .card-content .label {
            font-size: 0.9rem;
            font-weight: 500;
            opacity: 0.8;
        }

        .dashboard-section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        .dashboard-section-title {
            font-size: 1.8rem;
            border-bottom: 2px solid var(--primary-accent-color);
            padding-bottom: 0.5rem;
        }
        .see-more-btn {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--secondary-accent-color);
            cursor: pointer;
            text-decoration: none;
            background-color: var(--card-bg-color);
            padding: 0.4rem 1rem;
            border-radius: 50px;
            border: 1px solid var(--secondary-accent-color);
            transition: all 0.2s ease;
        }
        .see-more-btn:hover {
            background-color: var(--secondary-accent-color);
            color: white;
        }

        /*------------------------------------*\
          #COMPONENTI
        \*------------------------------------*/
        #login-card {
            background-color: var(--card-bg-color);
            padding: 2.5rem 2rem;
            border-radius: 28px;
            box-shadow: 0 10px 30px var(--shadow-color);
            width: 100%;
            max-width: 400px;
            text-align: center;
            border: 1px solid var(--border-color);
        }
        #login-card .login-icon {
            font-size: 4rem;
            color: var(--secondary-accent-color);
            margin-bottom: 1rem;
        }
        #login-card h2 { margin-bottom: 1.5rem; color: var(--heading-color); }
        #login-error { color: var(--danger-color); margin-top: 1rem; font-size: 0.9rem; min-height: 20px; }
        #email-input { background-color: white !important; color: #333 !important; border-radius: 50px !important; text-align: center; }

        .shift-card {
            background-color: var(--card-bg-color);
            border-radius: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 5px 20px var(--shadow-color);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            padding: 0.6rem;
        }
        .shift-card-inner { display: flex; align-items: stretch; }
        .card-sidebar { padding: 0.8rem 0.5rem; display: flex; flex-direction: column; justify-content: center; align-items: center; min-width: 80px; text-align: center; margin-right: 0.8rem; }
        .card-sidebar .time-label { font-size: 0.7rem; text-transform: uppercase; opacity: 0.6; font-weight: 700; }
        .card-sidebar .time-value { font-size: 1.2rem; font-weight: 700; }
        .card-main { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; cursor: pointer; border-radius: 0.75rem; overflow: hidden; transition: background-color 0.3s; }
        .card-main-content { padding: 0.8rem 1.2rem; position: relative; }
        
        /* CONTRASTO MIGLIORATO CARD TURNI */
        .shift-header-info p { margin: 0; font-size: 1rem; font-weight: 700; color: var(--bg-color); text-shadow: none; }
        .shift-header-info h3 { font-size: 1.4rem; color: var(--bg-color); margin: 0.25rem 0 0 0; text-shadow: none; }
        body.light-theme .shift-header-info p,
        body.light-theme .shift-header-info h3 {
            color: var(--heading-color);
        }
        .expand-arrow { position: absolute; top: 1rem; right: 1rem; transform: rotate(0deg); transition: transform 0.3s ease; font-size: 1.5rem; color: var(--bg-color); text-shadow: none; }


        .shift-details { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out, padding 0.5s ease; background-color: var(--card-bg-color); padding: 0 1.5rem; }
        .shift-card.expanded .shift-details { max-height: 500px; padding: 1.5rem; }
        .shift-details p { margin-bottom: 0.5rem; }
        .shift-details p strong { color: var(--secondary-accent-color); margin-right: 0.5rem; font-weight: 700; }
        .shift-card.past { opacity: 0.6; }
        .shift-card.ongoing { animation: pulse-border 2s infinite; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content { background: var(--card-bg-color); padding: 2rem; border-radius: 28px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 40px var(--shadow-color); transform: scale(0.9); transition: transform 0.3s; border: 1px solid var(--border-color); }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; }
        .modal-header h2 { color: var(--primary-accent-color); font-size: 1.8rem; }
        .modal-close-btn { background: none; border: none; color: var(--text-color); font-size: 2rem; cursor: pointer; }

        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 700; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 0.8rem 1rem; border-radius: 12px; border: 1px solid var(--border-color); background-color: var(--bg-color); color: var(--text-color); font-size: 1rem; font-family: var(--font-family-body); }
        .form-group textarea { resize: vertical; min-height: 80px; }
        
        .btn { padding: 0.8rem 1.5rem; border-radius: 50px; border: 2px solid transparent; cursor: pointer; font-weight: 700; font-family: var(--font-family-body); transition: all 0.3s; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; position: relative; min-height: 48px; }
        .btn-loader { font-size: 1.5rem; }
        
        /* PULSANTI CON GRADIENTE GEMINI */
        .btn-primary {
            background-image: linear-gradient(45deg, var(--gemini-blue), var(--gemini-green));
            color: #ffffff;
            border: none;
        }
        .btn-primary:hover { opacity: 0.9; }
        
        .btn-secondary { background-color: var(--primary-accent-color); color: #ffffff; border-color: var(--primary-accent-color); }
        .btn-secondary:hover { background-color: transparent; color: var(--primary-accent-color); }
        .btn-danger { background-color: var(--danger-color); color: #ffffff; border-color: var(--danger-color); }
        .btn-danger:hover { background-color: transparent; color: var(--danger-color); }
        .btn-block { width: 100%; margin-top: 1rem; }

        .theme-switcher { display: flex; align-items: center; gap: 1rem; }
        .switch { position: relative; display: inline-block; width: 60px; height: 34px; }
        .switch input { display: none; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 26px; width: 26px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary-accent-color); }
        input:checked + .slider:before { transform: translateX(26px); }

        .admin-section { margin-bottom: 2rem; }
        .admin-section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid var(--primary-accent-color); flex-wrap: wrap; gap: 1rem; }
        
        .volunteer-item { background: var(--card-bg-color); border-radius: 16px; margin-bottom: 0.5rem; border-left: 5px solid var(--secondary-accent-color); }
        .volunteer-summary { padding: 0.8rem 1.2rem; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .volunteer-details { display: none; padding: 1rem 1.2rem; border-top: 1px solid var(--border-color); }
        .volunteer-details.expanded { display: block; }
        .volunteer-details p { margin-bottom: 0.5rem; }
        .volunteer-actions { margin-top: 1rem; display: flex; gap: 0.5rem; flex-wrap: wrap; }
        
        .category-item { display: flex; justify-content: space-between; align-items: center; padding: 0.8rem; border-bottom: 1px solid var(--border-color); }
        .category-item:last-child { border-bottom: none; }
        #add-category-form { display: flex; gap: 0.5rem; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color); }
        #add-category-form input { flex-grow: 1; }
        
        .accordion-item { border-radius: 16px; overflow: hidden; margin-bottom: 1rem; background: var(--card-bg-color); border: 1px solid var(--border-color); }
        .accordion-header { background-color: transparent; padding: 1rem 1.5rem; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .accordion-body { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-out; border-top: 1px solid var(--border-color); }
        .accordion-body.show { max-height: 1500px; }
        
        .shift-admin-item { display: flex; justify-content: space-between; align-items: center; padding: 1rem 1.5rem; }
        .shift-admin-item:not(:last-child) { border-bottom: 1px solid var(--border-color); }
        .shift-admin-info h4 { font-family: var(--font-family-body); font-weight: 700; font-size: 1.1rem; margin: 0 0 0.25rem 0; color: var(--heading-color); }
        .shift-admin-info p { font-size: 0.9rem; color: var(--text-color); opacity: 0.8; margin: 0; }
        .shift-admin-actions { display: flex; gap: 0.5rem; }
        
        /* NUOVO STILE CARD EVENTI */
        .event-grid { display: grid; grid-template-columns: 1fr; gap: 1.5rem; }
        @media (min-width: 768px) { .event-grid { grid-template-columns: repeat(2, 1fr); } }
        
        .race-program-section h3 { border-bottom: 2px solid var(--secondary-accent-color); padding-bottom: 0.5rem; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; }
        
        .race-event-card {
            background-color: var(--card-bg-color);
            border-radius: 16px;
            box-shadow: 0 5px 20px var(--shadow-color);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            border: 1px solid var(--border-color);
            padding: 1rem 1.5rem;
        }
        .race-event-card:hover { transform: translateY(-3px); box-shadow: 0 8px 25px var(--shadow-color); }
        .race-event-card.past { opacity: 0.6; }
        .race-event-card.ongoing { animation: pulse-border 2s infinite; }

        .race-event-top-row { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem; }
        .race-event-icon { font-size: 1.8rem; color: var(--secondary-accent-color); }
        .race-event-pills { flex-grow: 1; display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap; }
        .event-name-pill { color: white; padding: 0.25rem 0.8rem; border-radius: 50px; font-weight: 700; font-size: 1rem; }
        .event-level-pill { border: 1px solid var(--text-color); color: var(--text-color); padding: 0.2rem 0.6rem; border-radius: 50px; font-size: 0.75rem; font-weight: 500; opacity: 0.8; }
        .race-event-actions { display: flex; gap: 0.5rem; }
        .race-event-actions .btn { padding: 0.6rem; width: 40px; height: 40px; }
        
        .race-event-details { padding-left: 2.55rem; }
        .race-event-details p { margin: 0; line-height: 1.4; }
        .race-event-details .event-time { font-weight: 700; color: var(--text-color); }
        .race-event-details .event-location { font-size: 0.9rem; opacity: 0.7; }
        
        .progress-bar-container {
            width: 100%;
            height: 18px; /* Aumentata altezza */
            background-color: rgba(0,0,0,0.2);
            border-radius: 18px;
            overflow: hidden;
            margin-top: 1rem;
            padding: 3px; /* Aumentato offset */
        }
        .progress-bar {
            height: 100%;
            border-radius: 12px;
            transition: width 0.5s ease, background-color 0.3s;
        }

        /* Notifiche */
        #notification-list { list-style: none; padding: 0; }
        .notification-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.2s;
        }
        .notification-item:last-child { border-bottom: none; }
        .notification-item:hover { background-color: rgba(255,255,255,0.05); }
        .notification-item.unread {
            background-color: rgba(23, 162, 184, 0.1);
            border-left: 3px solid var(--secondary-accent-color);
        }
        .notification-content { flex-grow: 1; }
        .notification-content p { margin: 0 0 0.25rem 0; }
        .notification-content .meta { font-size: 0.8rem; opacity: 0.6; }
        .delete-notification-btn {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 1.5rem;
            cursor: pointer;
            opacity: 0.5;
            transition: opacity 0.2s;
        }
        .notification-item:hover .delete-notification-btn { opacity: 1; }
        .notification-panel-actions {
            padding: 1rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 1rem;
        }


        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 2000; }
        .toast { background-color: var(--card-bg-color); color: var(--text-color); padding: 1rem 1.5rem; border-radius: 12px; margin-bottom: 1rem; box-shadow: 0 4px 15px var(--shadow-color); opacity: 0; transition: opacity 0.5s, transform 0.5s; transform: translateX(100%); }
        .toast.show { opacity: 1; transform: translateX(0); }
        .toast.success { border-left: 5px solid var(--success-color); }
        .toast.error { border-left: 5px solid var(--danger-color); }

    </style>
</head>

<body>
    <div id="app-container">
        <!-- VISTA LOGIN -->
        <div id="login-view">
            <div id="login-card">
                <i class='bx bx-user-circle login-icon'></i>
                <h2>Benvenuto</h2>
                <p class="subtitle">Accedi con la tua email da volontario</p>
                <form id="login-form">
                    <div class="form-group">
                        <input type="email" id="email-input" placeholder="La tua email" required>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block" id="login-button">
                        <span class="btn-text">Accedi</span>
                        <i class='bx bx-loader-alt bx-spin btn-loader hidden'></i>
                    </button>
                    <p id="login-error">&nbsp;</p>
                </form>
            </div>
        </div>

        <!-- VISTA APPLICAZIONE -->
        <div id="app-view" class="hidden">
            <header class="app-header">
                <h1 id="header-title">I Miei Turni</h1>
                <div class="header-icons">
                    <i class='bx bx-bell icon-btn' id="notifications-btn">
                        <span class="notification-badge hidden"></span>
                    </i>
                    <i class='bx bx-user icon-btn' id="profile-btn-header"></i>
                </div>
            </header>

            <main id="content-area">
                <!-- Le viste verranno renderizzate qui -->
            </main>

            <nav class="bottom-nav">
                 <button class="nav-button active" data-view="dashboard">
                    <i class='bx bxs-home'></i>
                </button>
                <button class="nav-button" data-view="my-shifts">
                    <i class='bx bx-calendar'></i>
                </button>
                <button class="nav-button" data-view="race-program">
                    <i class='bx bx-grid-alt'></i>
                </button>
                <button class="nav-button" data-view="admin-panel" id="admin-nav-button">
                    <i class='bx bx-cog'></i>
                </button>
            </nav>
        </div>
    </div>
    
    <div id="modal-container"></div>
    
    <div id="toast-container"></div>

    <script type="module">
        // Importa le funzioni necessarie dai vari SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            doc, 
            getDoc, 
            getDocs, 
            setDoc,
            addDoc,
            deleteDoc,
            query,
            where,
            onSnapshot,
            writeBatch,
            serverTimestamp,
            updateDoc,
            arrayUnion
        } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-firestore.js";

        // ********************************************************************
        // ** CONFIGURAZIONE FIREBASE
        // ********************************************************************
        const firebaseConfig = {
            apiKey: "AIzaSyA3yyNPkWWqWxkj9VGR391bnLyrSr-wTg4",
            authDomain: "gestione-volontari-evento.firebaseapp.com",
            projectId: "gestione-volontari-evento",
            storageBucket: "gestione-volontari-evento.appspot.com",
            messagingSenderId: "507852528635",
            appId: "1:507852528635:web:d6de64b7c45b943892895e",
            measurementId: "G-Z2B36R1WXR"
        };

        // Inizializza Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Riferimenti alle collezioni
        const volunteersCol = collection(db, "volunteers");
        const shiftsCol = collection(db, "shifts");
        const assignmentsCol = collection(db, "assignments");
        const categoriesCol = collection(db, "shift_categories");
        const raceEventsCol = collection(db, "race_events");
        const notificationsCol = collection(db, "notifications");
        const settingsDoc = doc(db, "app_settings", "general");

        // Stato dell'applicazione
        const AppState = {
            currentUser: null,
            volunteers: [],
            shifts: [],
            assignments: [],
            shiftCategories: [],
            raceEvents: [],
            notifications: [],
            unreadCount: 0,
            appSettings: {},
            currentView: 'dashboard',
            progressInterval: null
        };

        // Elementi DOM principali
        const loginView = document.getElementById('login-view');
        const appView = document.getElementById('app-view');
        const loginForm = document.getElementById('login-form');
        const emailInput = document.getElementById('email-input');
        const loginError = document.getElementById('login-error');
        const contentArea = document.getElementById('content-area');
        const appHeader = document.querySelector('.app-header');
        const headerTitle = document.getElementById('header-title');
        const navButtons = document.querySelectorAll('.nav-button');
        const adminNavButton = document.getElementById('admin-nav-button');
        const profileBtnHeader = document.getElementById('profile-btn-header');
        const notificationsBtn = document.getElementById('notifications-btn');
        const modalContainer = document.getElementById('modal-container');
        const toastContainer = document.getElementById('toast-container');
        
        const SPORT_DETAILS = {
            'Velocità': { icon: 'bx-run', color: '#f39c12' },
            'Maratonina': { icon: 'bx-walk', color: '#3498db' },
            'Staffetta': { icon: 'bx-transfer', color: '#2ecc71' },
            'Tiro al bersaglio - Nerf': { icon: 'bx-target-lock', color: '#e74c3c' },
            'Lancio del vortex': { icon: 'bx-rocket', color: '#9b59b6' },
            'Kan-jam frisbee': { icon: 'bx-disc', color: '#1abc9c' },
            'Salto in lungo': { icon: 'bx-ruler', color: '#e67e22' },
            'Calci di rigore': { icon: 'bx-football', color: '#27ae60' },
            'Bocce curling': { icon: 'bx-circle', color: '#34495e' },
            'Tiri liberi basket': { icon: 'bx-basketball', color: '#d35400' }
        };


        // ====================================================================
        // FUNZIONI DI UTILITY
        // ====================================================================
        
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            toastContainer.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 500);
            }, 3000);
        }

        function toggleLoader(show) { console.log(`Loader: ${show}`); }

        function renderModal(title, contentHtml, onOpen = () => {}) {
            modalContainer.innerHTML = `
                <div class="modal-overlay">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2>${title}</h2>
                            <button class="modal-close-btn">&times;</button>
                        </div>
                        <div class="modal-body">${contentHtml}</div>
                    </div>
                </div>`;
            const modalOverlay = modalContainer.querySelector('.modal-overlay');
            setTimeout(() => modalOverlay.classList.add('visible'), 10);
            const closeModal = () => {
                modalOverlay.classList.remove('visible');
                setTimeout(() => { modalContainer.innerHTML = ''; }, 300);
            };
            modalContainer.querySelector('.modal-close-btn').addEventListener('click', closeModal);
            modalOverlay.addEventListener('click', (e) => { if (e.target === modalOverlay) closeModal(); });
            window.closeCurrentModal = closeModal;
            if (onOpen) onOpen();
        }

        function showConfirmationModal(message, onConfirm) {
            const contentHtml = `
                <p>${message}</p>
                <div style="display: flex; justify-content: flex-end; gap: 1rem; margin-top: 2rem;">
                    <button id="confirm-cancel-btn" class="btn">Annulla</button>
                    <button id="confirm-action-btn" class="btn btn-danger">Conferma</button>
                </div>
            `;
            renderModal('Sei sicuro?', contentHtml, () => {
                document.getElementById('confirm-action-btn').addEventListener('click', () => {
                    onConfirm();
                });
                document.getElementById('confirm-cancel-btn').addEventListener('click', () => {
                    window.closeCurrentModal();
                });
            });
        }

        function applyTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.body.classList.toggle('light-theme', savedTheme === 'light');
        }

        function toCssClass(text) {
            if (!text) return '';
            return text.toLowerCase().replace(/[^a-z0-9]/g, '-').replace(/-+/g, '-');
        }
        
        function calculateProgress(dateStr, startTimeStr, endTimeStr) {
            const now = new Date();
            const start = new Date(`${dateStr.split('/').reverse().join('-')}T${startTimeStr}`);
            const end = new Date(`${dateStr.split('/').reverse().join('-')}T${endTimeStr}`);
            if (now < start) return 0;
            if (now > end) return 100;
            const totalDuration = end.getTime() - start.getTime();
            if (totalDuration === 0) return 100;
            const elapsedTime = now.getTime() - start.getTime();
            return Math.min(100, (elapsedTime / totalDuration) * 100);
        }
        
        function updateProgressBars() {
            document.querySelectorAll('.progress-bar-container[data-start-time]').forEach(container => {
                const date = container.dataset.date;
                const startTime = container.dataset.startTime;
                const endTime = container.dataset.endTime;
                const progress = calculateProgress(date, startTime, endTime);
                const bar = container.querySelector('.progress-bar');
                if(bar) bar.style.width = `${progress}%`;
            });
        }
        
        function shadeColor(hex, percent) {
            let R = parseInt(hex.substring(1,3),16);
            let G = parseInt(hex.substring(3,5),16);
            let B = parseInt(hex.substring(5,7),16);
            R = parseInt(R * (100 + percent) / 100);
            G = parseInt(G * (100 + percent) / 100);
            B = parseInt(B * (100 + percent) / 100);
            R = (R<255)?R:255;  
            G = (G<255)?G:255;  
            B = (B<255)?B:255;  
            const RR = ((R.toString(16).length==1)?"0"+R.toString(16):R.toString(16));
            const GG = ((G.toString(16).length==1)?"0"+G.toString(16):G.toString(16));
            const BB = ((B.toString(16).length==1)?"0"+B.toString(16):B.toString(16));
            return "#"+RR+GG+BB;
        }


        // ====================================================================
        // FUNZIONI DI AUTENTICAZIONE E SESSIONE
        // ====================================================================
        
        async function checkSession() {
            toggleLoader(true);
            const userEmail = localStorage.getItem('userEmail');
            try {
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Errore di login anonimo:", error);
                loginError.textContent = "Errore di connessione a Firebase.";
                toggleLoader(false);
                showLoginView();
                return;
            }

            if (userEmail) {
                try {
                    const userDoc = await getDoc(doc(db, 'volunteers', userEmail));
                    if (userDoc.exists()) {
                        AppState.currentUser = { id: userDoc.id, ...userDoc.data() };
                        initializeAppUI();
                    } else {
                        localStorage.removeItem('userEmail');
                        showLoginView();
                    }
                } catch (error) {
                     console.error("Errore controllo sessione:", error);
                     loginError.textContent = 'Errore di connessione nel controllo sessione.';
                     showLoginView();
                }
            } else {
                showLoginView();
            }
            toggleLoader(false);
        }

        async function handleLogin(e) {
            e.preventDefault();
            const loginButton = document.getElementById('login-button');
            const buttonText = loginButton.querySelector('.btn-text');
            const buttonLoader = loginButton.querySelector('.btn-loader');
            loginButton.disabled = true;
            buttonText.classList.add('hidden');
            buttonLoader.classList.remove('hidden');
            const email = emailInput.value.trim().toLowerCase();
            loginError.textContent = '\u00A0';

            try {
                const userDoc = await getDoc(doc(db, 'volunteers', email));
                if (userDoc.exists()) {
                    AppState.currentUser = { id: userDoc.id, ...userDoc.data() };
                    localStorage.setItem('userEmail', email);
                    initializeAppUI();
                } else {
                    loginError.textContent = 'Email non trovata. Contatta un responsabile.';
                }
            } catch (error) {
                console.error("Errore durante il login:", error);
                loginError.textContent = 'Si è verificato un errore di connessione. Riprova.';
            } finally {
                loginButton.disabled = false;
                buttonText.classList.remove('hidden');
                buttonLoader.classList.add('hidden');
            }
        }
        
        function handleLogout() {
            localStorage.removeItem('userEmail');
            AppState.currentUser = null;
            if(AppState.progressInterval) clearInterval(AppState.progressInterval);
            window.location.reload();
        }

        // ====================================================================
        // GESTIONE VISTE E UI
        // ====================================================================
        
        function showLoginView() {
            loginView.classList.remove('hidden');
            appView.classList.add('hidden');
        }

        function initializeAppUI() {
            loginView.classList.add('hidden');
            appView.classList.remove('hidden');
            updateUIBasedOnRole();
            setupEventListeners();
            startRealtimeListeners();
            switchView(AppState.currentView);
            if(AppState.progressInterval) clearInterval(AppState.progressInterval);
            AppState.progressInterval = setInterval(updateProgressBars, 60000);
        }
        
        function updateUIBasedOnRole() {
            const isAdmin = AppState.currentUser.ruolo === 'Admin' || AppState.currentUser.ruolo === 'Responsabile';
            adminNavButton.style.display = isAdmin ? 'flex' : 'none';
        }

        function setupEventListeners() {
            navButtons.forEach(button => {
                button.addEventListener('click', () => switchView(button.dataset.view));
            });
            profileBtnHeader.addEventListener('click', showProfileModal);
            notificationsBtn.addEventListener('click', showNotificationsPanel);
            contentArea.addEventListener('click', e => {
                const colleaguesBtn = e.target.closest('.view-colleagues-btn');
                if (colleaguesBtn) {
                    e.stopPropagation();
                    showColleaguesModal(colleaguesBtn.dataset.shiftId);
                    return;
                }
                const card = e.target.closest('.shift-card');
                if(card) card.classList.toggle('expanded');

                const seeMoreBtn = e.target.closest('.see-more-btn');
                if(seeMoreBtn) switchView(seeMoreBtn.dataset.view);
                
                const meetingCard = e.target.closest('#meeting-card');
                if(meetingCard) showMeetingInfoModal();
            });
        }
        
        function switchView(viewName) {
            AppState.currentView = viewName;

            navButtons.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === viewName);
            });
            
            // Gestione header
            appHeader.classList.toggle('dashboard-mode', viewName === 'dashboard');
            headerTitle.classList.toggle('hidden', viewName === 'dashboard');

            contentArea.innerHTML = '';
            switch (viewName) {
                case 'dashboard': renderDashboard(); break;
                case 'my-shifts': headerTitle.textContent = "I Miei Turni"; renderMyShifts(); break;
                case 'race-program': headerTitle.textContent = "Programma Gare"; renderRaceProgram(); break;
                case 'admin-panel': headerTitle.textContent = "Pannello Admin"; renderAdminPanel(); break;
            }
            updateProgressBars();
        }
        
        function startRealtimeListeners() {
            // Listener per le notifiche
            const q = query(notificationsCol, where('targetEmails', 'array-contains', AppState.currentUser.email));
            onSnapshot(q, (snapshot) => {
                AppState.notifications = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}))
                    .filter(n => !(n.deletedBy && n.deletedBy.includes(AppState.currentUser.email)));
                
                // Ordina le notifiche lato client
                AppState.notifications.sort((a, b) => {
                    const timeA = a.timestamp?.toMillis() || 0;
                    const timeB = b.timestamp?.toMillis() || 0;
                    return timeB - timeA; // Dal più recente al meno recente
                });
                AppState.unreadCount = AppState.notifications.filter(n => !n.readBy.includes(AppState.currentUser.email)).length;
                updateNotificationBell();
            });

            onSnapshot(settingsDoc, (doc) => {
                AppState.appSettings = doc.exists() ? doc.data() : {};
                if (AppState.currentView === 'dashboard') renderDashboard();
            });
            onSnapshot(volunteersCol, (snapshot) => {
                AppState.volunteers = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a,b) => a.cognome.localeCompare(b.cognome));
                if (AppState.currentView === 'admin-panel') renderAdminPanel();
                if (AppState.currentView === 'dashboard') renderDashboard();
            });
            onSnapshot(shiftsCol, (snapshot) => {
                AppState.shifts = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (['my-shifts', 'dashboard', 'admin-panel'].includes(AppState.currentView)) switchView(AppState.currentView);
            });
            onSnapshot(assignmentsCol, (snapshot) => {
                AppState.assignments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (['my-shifts', 'dashboard', 'admin-panel'].includes(AppState.currentView)) switchView(AppState.currentView);
            });
            onSnapshot(categoriesCol, (snapshot) => {
                AppState.shiftCategories = snapshot.docs.map(doc => doc.id).sort();
                if (AppState.currentView === 'admin-panel') renderAdminPanel();
            });
            onSnapshot(raceEventsCol, (snapshot) => {
                AppState.raceEvents = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (['race-program', 'dashboard'].includes(AppState.currentView)) switchView(AppState.currentView);
            });
        }

        // ====================================================================
        // FUNZIONI DI RENDER VISTE
        // ====================================================================
        
        const categoryColors = ['#e74c3c', '#8e44ad', '#3498db', '#1abc9c', '#f1c40f', '#e67e22', '#7f8c8d'];
        function getCategoryColor(categoryName) {
            let hash = 0;
            if (!categoryName || categoryName.length === 0) return categoryColors[0];
            for (let i = 0; i < categoryName.length; i++) {
                hash = categoryName.charCodeAt(i) + ((hash << 5) - hash);
            }
            return categoryColors[Math.abs(hash) % categoryColors.length];
        }

        function renderDashboard() {
            const now = new Date();
            const { abbadiadiDate, meetingDate } = AppState.appSettings;
            
            const targetDate = abbadiadiDate ? new Date(abbadiadiDate) : new Date('2026-06-02T00:00:00');
            const diffTime = targetDate - now;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            const userAssignments = AppState.assignments.filter(a => a.email_volontario === AppState.currentUser.email);
            const myShiftIds = new Set(userAssignments.map(a => a.id_turno));
            const myShifts = AppState.shifts.filter(s => myShiftIds.has(s.id_turno));
            
            const completedShifts = myShifts.filter(s => new Date(`${s.data_inizio.split('/').reverse().join('-')}T${s.ora_fine}`) < now).length;

            const nextGeneralEvent = AppState.raceEvents
                .filter(e => e.tipologia === 'Generale' && new Date(`${e.date.split('/').reverse().join('-')}T${e.startTime}`) > now)
                .sort((a, b) => new Date(`${a.date.split('/').reverse().join('-')}T${a.startTime}`) - new Date(`${b.date.split('/').reverse().join('-')}T${b.startTime}`))[0];

            const oneHourFromNow = new Date(now.getTime() + 60 * 60 * 1000);
            const upcomingShifts = myShifts
                .filter(s => {
                    const shiftEnd = new Date(`${s.data_inizio.split('/').reverse().join('-')}T${s.ora_fine}`);
                    const shiftStart = new Date(`${s.data_inizio.split('/').reverse().join('-')}T${s.ora_inizio}`);
                    return shiftEnd > now && shiftStart < oneHourFromNow;
                })
                .sort((a, b) => new Date(`${a.data_inizio.split('/').reverse().join('-')}T${a.ora_inizio}`) - new Date(`${b.data_inizio.split('/').reverse().join('-')}T${b.ora_inizio}`));

            const ongoingEvents = AppState.raceEvents.filter(event => {
                const startDate = new Date(`${event.date.split('/').reverse().join('-')}T${event.startTime}`);
                const endDate = new Date(`${event.date.split('/').reverse().join('-')}T${event.endTime}`);
                return now >= startDate && now <= endDate;
            });
            
            contentArea.innerHTML = `
                <div id="dashboard-view">
                    <div class="dashboard-header">
                        <div class="welcome-text">
                            <h2>Ciao, ${AppState.currentUser.nome}!</h2>
                            <p>Ecco un riepilogo delle tue attività.</p>
                        </div>
                    </div>

                    <div class="summary-card-container">
                        <div class="summary-card">
                            <div class="icon-wrapper" style="background-color: rgba(205, 164, 52, 0.2); color: var(--primary-accent-color);"><i class='bx bx-calendar-event'></i></div>
                            <div class="card-content">
                                <div class="value">${diffDays > 0 ? diffDays : '0'} giorni</div>
                                <div class="label">alle Abbadiadi</div>
                            </div>
                        </div>
                        <div class="summary-card" id="meeting-card">
                            <div class="icon-wrapper" style="background-color: rgba(253, 126, 20, 0.2); color: #fd7e14;"><i class='bx bx-group'></i></div>
                            <div class="card-content">
                                <div class="value">Riunione Volontari</div>
                                <div class="label">${meetingDate || 'Non definita'}</div>
                            </div>
                        </div>
                        <div class="summary-card" id="weather-card">
                            <div class="icon-wrapper" style="background-color: rgba(23, 162, 184, 0.2); color: var(--secondary-accent-color);"><i class='bx bx-loader-alt bx-spin'></i></div>
                            <div class="card-content">
                                <div class="value">Carico...</div>
                                <div class="label">Meteo a Pinerolo</div>
                            </div>
                        </div>
                        <div class="summary-card">
                            <div class="icon-wrapper" style="background-color: rgba(46, 204, 113, 0.2); color: var(--success-color);"><i class='bx bx-check-circle'></i></div>
                            <div class="card-content">
                                <div class="value">${completedShifts} / ${myShifts.length}</div>
                                <div class="label">Turni completati</div>
                            </div>
                        </div>
                        <div class="summary-card">
                            <div class="icon-wrapper" style="background-color: rgba(136, 84, 208, 0.2); color: var(--general-event-color);"><i class='bx bx-bell'></i></div>
                            <div class="card-content">
                                <div class="value">${nextGeneralEvent ? nextGeneralEvent.eventName : 'Nessuno'}</div>
                                <div class="label">Prossimo evento</div>
                            </div>
                        </div>
                    </div>
                    
                    ${upcomingShifts.length > 0 ? `
                    <div class="dashboard-section">
                        <div class="dashboard-section-header">
                            <h3 class="dashboard-section-title">I miei prossimi turni</h3>
                            <a href="#" class="see-more-btn" data-view="my-shifts">Vedi tutti &rarr;</a>
                        </div>
                        <div id="upcoming-shifts-list">${upcomingShifts.map(shift => renderShiftCard(shift)).join('')}</div>
                    </div>` : ''}

                    ${ongoingEvents.length > 0 ? `
                    <div class="dashboard-section">
                        <div class="dashboard-section-header">
                            <h3 class="dashboard-section-title">Eventi in corso</h3>
                            <a href="#" class="see-more-btn" data-view="race-program">Vedi tutti &rarr;</a>
                        </div>
                        <div id="ongoing-events-list">${ongoingEvents.map(event => renderFullEventCard(event, true, false, false)).join('')}</div>
                    </div>` : ''}
                </div>
            `;
            
            fetchWeather();
        }
        
        async function fetchWeather() {
            const weatherCard = document.getElementById('weather-card');
            if (!weatherCard) return;
            // Pinerolo, Italy coordinates
            const lat = 44.88;
            const lon = 7.33;
            const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,weather_code`;

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();
                const condition = data.current;
                const weatherCode = condition.weather_code;
                const temperature = condition.temperature_2m;

                const iconClass = getWeatherIcon(weatherCode);
                const description = getWeatherDescription(weatherCode);

                weatherCard.innerHTML = `
                    <div class="icon-wrapper" style="background-color: rgba(23, 162, 184, 0.2); color: var(--secondary-accent-color);"><i class='bx ${iconClass}'></i></div>
                    <div class="card-content">
                        <div class="value">${Math.round(temperature)}°C</div>
                        <div class="label">${description}</div>
                    </div>
                `;
            } catch (error) {
                console.error("Failed to fetch weather:", error);
                const content = weatherCard.querySelector('.card-content');
                if(content) {
                    content.querySelector('.value').textContent = 'Errore';
                    content.querySelector('.label').textContent = 'Meteo a Pinerolo';
                }
            }
        }

        function getWeatherIcon(code) {
            if (code === 0) return 'bxs-sun'; // Clear sky
            if (code >= 1 && code <= 3) return 'bxs-cloud'; // Mainly clear, partly cloudy, overcast
            if (code >= 45 && code <= 48) return 'bxs-cloud'; // Fog
            if (code >= 51 && code <= 57) return 'bxs-cloud-drizzle'; // Drizzle
            if (code >= 61 && code <= 67) return 'bxs-cloud-rain'; // Rain
            if (code >= 71 && code <= 77) return 'bxs-cloud-snow'; // Snow
            if (code >= 80 && code <= 82) return 'bxs-cloud-showers'; // Rain showers
            if (code >= 85 && code <= 86) return 'bxs-cloud-snow'; // Snow showers
            if (code >= 95 && code <= 99) return 'bxs-thunderstorm'; // Thunderstorm
            return 'bx-question-mark';
        }

        function getWeatherDescription(code) {
            const descriptions = {
                0: 'Sereno', 1: 'Prevalentemente sereno', 2: 'Parzialmente nuvoloso', 3: 'Nuvoloso', 45: 'Nebbia', 48: 'Nebbia con brina', 51: 'Pioggerella leggera', 53: 'Pioggerella', 55: 'Pioggerella forte', 56: 'Pioggerella gelata', 57: 'Pioggerella gelata', 61: 'Pioggia debole', 63: 'Pioggia', 65: 'Pioggia forte', 66: 'Pioggia gelata', 67: 'Pioggia gelata', 71: 'Nevicata debole', 73: 'Nevicata', 75: 'Nevicata forte', 77: 'Gragnola', 80: 'Rovescio debole', 81: 'Rovescio', 82: 'Rovescio forte', 85: 'Rovescio di neve', 86: 'Rovescio di neve', 95: 'Temporale', 96: 'Temporale con grandine', 99: 'Temporale con grandine',
            };
            return descriptions[code] || 'Sconosciuto';
        }


        function renderMyShifts() {
            const userAssignments = AppState.assignments.filter(a => a.email_volontario === AppState.currentUser.email);
            const myShiftIds = new Set(userAssignments.map(a => a.id_turno));
            const myShifts = AppState.shifts.filter(s => myShiftIds.has(s.id_turno));
            myShifts.sort((a, b) => new Date(a.data_inizio.split('/').reverse().join('-') + 'T' + a.ora_inizio) - new Date(b.data_inizio.split('/').reverse().join('-') + 'T' + b.ora_inizio));
            contentArea.innerHTML = myShifts.length > 0 ? myShifts.map(shift => renderShiftCard(shift)).join('') : `<p>Non hai ancora turni assegnati.</p>`;
        }
        
        function renderShiftCard(shift) {
            const now = new Date();
            const shiftStart = new Date(`${shift.data_inizio.split('/').reverse().join('-')}T${shift.ora_inizio}`);
            const shiftEnd = new Date(`${shift.data_inizio.split('/').reverse().join('-')}T${shift.ora_fine}`);
            const isPast = shiftEnd < now;
            const isOngoing = now >= shiftStart && now <= shiftEnd;
            
            const baseColor = getCategoryColor(shift.categoria);
            const lightColor = shadeColor(baseColor, 40);
            const darkColor = shadeColor(baseColor, -60); // Più scuro

            let progressBarHtml = '';
            if(isOngoing){
                const progress = calculateProgress(shift.data_inizio, shift.ora_inizio, shift.ora_fine);
                progressBarHtml = `
                    <div class="progress-bar-container" data-date="${shift.data_inizio}" data-start-time="${shift.ora_inizio}" data-end-time="${shift.ora_fine}">
                       <div class="progress-bar" style="width: ${progress}%; background-color: ${darkColor};"></div>
                    </div>`;
            }

            return `
                <div class="shift-card ${isPast ? 'past' : ''} ${isOngoing ? 'ongoing' : ''}">
                    <div class="shift-card-inner">
                        <div class="card-sidebar">
                            <div><div class="time-label">Inizio</div><div class="time-value">${shift.ora_inizio}</div></div>
                            <div style="margin-top: 1rem;"><div class="time-label">Fine</div><div class="time-value">${shift.ora_fine}</div></div>
                        </div>
                        <div class="card-main" style="background-color: ${lightColor};">
                            <div class="card-main-content">
                                <div class="shift-header-info">
                                    <h3>${shift.nome_turno}</h3>
                                    <p>${shift.categoria}</p>
                                </div>
                                ${progressBarHtml}
                                <i class='bx bx-chevron-down expand-arrow'></i>
                            </div>
                        </div>
                    </div>
                    <div class="shift-details" style="border-color: ${baseColor};">
                        <p><strong>Data:</strong> ${shift.data_inizio}</p>
                        <p><strong>Descrizione:</strong> ${shift.descrizione}</p>
                        <p><strong>Luogo:</strong> ${shift.luogo}</p>
                        <div style="margin-top: 1rem;"><button class="btn btn-secondary view-colleagues-btn" data-shift-id="${shift.id_turno}"><i class='bx bx-group'></i> Vedi Altri Volontari</button></div>
                    </div>
                </div>`;
        }
        
        function renderRaceProgram() {
            const isAdmin = AppState.currentUser.ruolo === 'Admin' || AppState.currentUser.ruolo === 'Responsabile';
            let adminButtonHtml = isAdmin ? `<div style="text-align: right; margin-bottom: 1.5rem;"><button class="btn btn-primary" id="add-race-event-btn"><i class='bx bx-plus'></i>Crea Evento</button></div>` : '';

            const now = new Date();
            const events = { ongoing: [], upcoming: [], past: [] };
            AppState.raceEvents.forEach(event => {
                const endDate = new Date(`${event.date.split('/').reverse().join('-')}T${event.endTime}`);
                if (endDate < now) events.past.push(event);
                else if (new Date(`${event.date.split('/').reverse().join('-')}T${event.startTime}`) > now) events.upcoming.push(event);
                else events.ongoing.push(event);
            });

            const renderEventList = (eventList, showAdminActions) => {
                if(eventList.length === 0) return '<p>Nessun evento in questa categoria.</p>';
                const gridHtml = eventList.sort((a,b) => new Date(`${a.date.split('/').reverse().join('-')}T${a.startTime}`) - new Date(`${b.date.split('/').reverse().join('-')}T${b.startTime}`)).map(event => renderFullEventCard(event, events.ongoing.includes(event), events.past.includes(event), showAdminActions)).join('');
                return `<div class="event-grid">${gridHtml}</div>`;
            };

            contentArea.innerHTML = `
                ${adminButtonHtml}
                <div class="race-program-section"><h3><i class='bx bx-play-circle' style="color: var(--ongoing-color);"></i>In Corso</h3>${renderEventList(events.ongoing, isAdmin)}</div>
                <div class="race-program-section"><h3><i class='bx bx-time-five' ></i>Prossimi Eventi</h3>${renderEventList(events.upcoming, isAdmin)}</div>
                <div class="race-program-section"><h3><i class='bx bx-check-double'></i>Conclusi</h3>${renderEventList(events.past, isAdmin)}</div>`;
            
            if (isAdmin) {
                document.getElementById('add-race-event-btn').addEventListener('click', () => showRaceEventForm());
                contentArea.querySelectorAll('.edit-race-event-btn').forEach(btn => btn.addEventListener('click', () => showRaceEventForm(btn.dataset.id)));
                contentArea.querySelectorAll('.delete-race-event-btn').forEach(btn => btn.addEventListener('click', () => handleDeleteRaceEvent(btn.dataset.id)));
            }
        }
        
        function renderFullEventCard(event, isOngoing, isPast, showAdminActions) {
            let pillColor = 'var(--general-event-color)';
            let icon = 'bx-calendar-event';
            
            if(event.tipologia === 'Sport') {
                const sportDetail = SPORT_DETAILS[event.eventName];
                if(sportDetail) {
                    icon = sportDetail.icon;
                    pillColor = sportDetail.color;
                } else {
                    icon = 'bx-trophy';
                }
            }

            let progressBarHtml = '';
            if(isOngoing){
                const progress = calculateProgress(event.date, event.startTime, event.endTime);
                progressBarHtml = `<div class="progress-bar-container" data-date="${event.date}" data-start-time="${event.startTime}" data-end-time="${event.endTime}"><div class="progress-bar" style="width: ${progress}%; background-color: ${pillColor};"></div></div>`;
            }

            return `
            <div class="race-event-card ${isOngoing ? 'ongoing' : ''} ${isPast ? 'past' : ''}">
                <div class="race-event-top-row">
                    <i class='bx ${icon} race-event-icon' style="color: ${pillColor};"></i>
                    <div class="race-event-pills">
                        <span class="event-name-pill" style="background-color: ${pillColor};">${event.eventName}</span>
                        <span class="event-level-pill">${event.level || 'Generale'}</span>
                    </div>
                    ${showAdminActions ? `
                    <div class="race-event-actions">
                        <button class="btn btn-primary edit-race-event-btn" data-id="${event.id}"><i class='bx bx-edit'></i></button>
                        <button class="btn btn-danger delete-race-event-btn" data-id="${event.id}"><i class='bx bx-trash'></i></button>
                    </div>` : ''}
                </div>
                <div class="race-event-details">
                    <p class="event-time">${event.startTime} - ${event.endTime}</p>
                    <p class="event-location">${event.location}</p>
                </div>
                ${progressBarHtml}
            </div>`;
        }
        
        function renderAdminPanel() {
            contentArea.innerHTML = `
                <section class="admin-section" id="admin-settings">
                     <div class="admin-section-header">
                        <h2>Impostazioni Generali</h2>
                        <button class="btn btn-secondary" id="manage-settings-btn"><i class='bx bx-edit-alt'></i>Modifica Dati</button>
                    </div>
                </section>
                <section class="admin-section" id="admin-volunteers">
                    <div class="admin-section-header"><h2>Volontari</h2><button class="btn btn-secondary" id="add-volunteer-btn"><i class='bx bx-plus'></i>Aggiungi</button></div>
                    <div id="volunteers-list"></div>
                </section>
                <section class="admin-section" id="admin-shifts">
                    <div class="admin-section-header"><h2>Turni</h2><div><button class="btn" id="manage-categories-btn" style="background-color: var(--border-color);"><i class='bx bx-category'></i> Gestisci Categorie</button><button class="btn btn-secondary" id="add-shift-main-btn"><i class='bx bx-plus'></i>Crea Turno</button></div></div>
                    <div id="shifts-accordion"></div>
                </section>`;
            
            renderVolunteersList();
            renderShiftsAccordion();
            
            document.getElementById('manage-settings-btn').addEventListener('click', showAppSettingsModal);
            document.getElementById('add-volunteer-btn').addEventListener('click', () => showVolunteerForm());
            document.getElementById('add-shift-main-btn').addEventListener('click', () => showShiftForm());
            document.getElementById('manage-categories-btn').addEventListener('click', showManageCategoriesModal);
            document.getElementById('volunteers-list').addEventListener('click', e => {
                 const summary = e.target.closest('.volunteer-summary');
                 if (summary) summary.nextElementSibling.classList.toggle('expanded');
            });
            document.getElementById('shifts-accordion').addEventListener('click', e => {
                const header = e.target.closest('.accordion-header');
                if (header) header.nextElementSibling.classList.toggle('show');
            });
        }
        
        function renderVolunteersList() {
            const listContainer = document.getElementById('volunteers-list');
            if (!listContainer) return;
            listContainer.innerHTML = AppState.volunteers.map(v => `<div class="volunteer-item" data-id="${v.id}"><div class="volunteer-summary"><span>${v.cognome} ${v.nome}</span><i class='bx bx-chevron-down'></i></div><div class="volunteer-details"><p><strong>Email:</strong> ${v.email}</p><p><strong>Telefono:</strong> ${v.telefono}</p><p><strong>Ruolo:</strong> ${v.ruolo}</p><div class="volunteer-actions"><button class="btn btn-secondary edit-volunteer-btn" data-id="${v.id}">Modifica</button><button class="btn btn-secondary view-shifts-btn" data-id="${v.id}">Vedi Turni</button></div></div></div>`).join('');
            listContainer.querySelectorAll('.edit-volunteer-btn').forEach(btn => btn.addEventListener('click', () => showVolunteerForm(btn.dataset.id)));
            listContainer.querySelectorAll('.view-shifts-btn').forEach(btn => btn.addEventListener('click', () => showVolunteerShiftsModal(btn.dataset.id)));
        }
        
        function renderShiftsAccordion() {
            const accordionContainer = document.getElementById('shifts-accordion');
            if (!accordionContainer) return;
            const shiftsByCategory = AppState.shifts.reduce((acc, shift) => {
                (acc[shift.categoria || 'Senza Categoria'] = acc[shift.categoria || 'Senza Categoria'] || []).push(shift);
                return acc;
            }, {});
            accordionContainer.innerHTML = Object.keys(shiftsByCategory).sort().map(category => `<div class="accordion-item" style="border-left-color: ${getCategoryColor(category)}"><div class="accordion-header"><h3>${category} (${shiftsByCategory[category].length})</h3><i class='bx bx-chevron-down'></i></div><div class="accordion-body">${shiftsByCategory[category].map(shift => `<div class="shift-admin-item"><div class="shift-admin-info"><h4>${shift.nome_turno}</h4><p>${shift.data_inizio} | ${shift.ora_inizio} - ${shift.ora_fine}</p></div><div class="shift-admin-actions"><button class="btn btn-primary edit-shift-btn" data-id="${shift.id}">Modifica</button><button class="btn btn-secondary manage-volunteers-btn" data-id="${shift.id}">Gestisci</button></div></div>`).join('')}</div></div>`).join('');
            accordionContainer.querySelectorAll('.edit-shift-btn').forEach(btn => btn.addEventListener('click', (e) => { e.stopPropagation(); showShiftForm(btn.dataset.id); }));
            accordionContainer.querySelectorAll('.manage-volunteers-btn').forEach(btn => btn.addEventListener('click', (e) => { e.stopPropagation(); showManageVolunteersModal(btn.dataset.id); }));
        }

        // ====================================================================
        // FUNZIONI MODALI E FORM
        // ====================================================================
        
        function showMeetingInfoModal() {
            const { meetingDate, meetingLocation, meetingDescription } = AppState.appSettings;
            if (!meetingDate) {
                renderModal('Riunione Volontari', '<p>Nessuna riunione in programma al momento.</p>');
                return;
            }
            const content = `
                <p><strong>Data:</strong> ${meetingDate}</p>
                <p><strong>Luogo:</strong> ${meetingLocation}</p>
                <hr style="margin: 1rem 0; border-color: var(--border-color);">
                <p>${meetingDescription}</p>
            `;
            renderModal('Dettagli Riunione Volontari', content);
        }

        function showAppSettingsModal() {
            const settings = AppState.appSettings;
            const formHtml = `
                <form id="app-settings-form">
                    <h4>Dati Abbadiadi</h4>
                    <div class="form-group">
                        <label for="abbadiadiDate">Data Evento (AAAA-MM-GG)</label>
                        <input type="date" id="abbadiadiDate" value="${settings.abbadiadiDate || ''}" required>
                    </div>
                    <hr style="margin: 2rem 0; border-color: var(--border-color);">
                    <h4>Dati Riunione Volontari</h4>
                    <div class="form-group">
                        <label for="meetingDate">Data Riunione</label>
                        <input type="text" id="meetingDate" placeholder="Es. Sabato 25 Maggio, ore 21:00" value="${settings.meetingDate || ''}">
                    </div>
                    <div class="form-group">
                        <label for="meetingLocation">Luogo Riunione</label>
                        <input type="text" id="meetingLocation" placeholder="Es. Oratorio San Filippo" value="${settings.meetingLocation || ''}">
                    </div>
                    <div class="form-group">
                        <label for="meetingDescription">Breve Descrizione</label>
                        <textarea id="meetingDescription">${settings.meetingDescription || ''}</textarea>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">Salva Impostazioni</button>
                </form>
            `;
            renderModal('Impostazioni Generali', formHtml, () => {
                document.getElementById('app-settings-form').addEventListener('submit', handleAppSettingsFormSubmit);
            });
        }

        async function handleAppSettingsFormSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const data = {
                abbadiadiDate: form.querySelector('#abbadiadiDate').value,
                meetingDate: form.querySelector('#meetingDate').value,
                meetingLocation: form.querySelector('#meetingLocation').value,
                meetingDescription: form.querySelector('#meetingDescription').value,
            };
            try {
                await setDoc(settingsDoc, data, { merge: true });
                showToast('Impostazioni salvate con successo!');
                window.closeCurrentModal();
            } catch (error) {
                console.error("Errore salvataggio impostazioni:", error);
                showToast('Errore durante il salvataggio.', 'error');
            }
        }
        
        function showColleaguesModal(shiftId) {
            const shift = AppState.shifts.find(s => s.id_turno === shiftId);
            if (!shift) return;
            const assignedEmails = AppState.assignments.filter(a => a.id_turno === shiftId).map(a => a.email_volontario);
            const colleagues = AppState.volunteers.filter(v => assignedEmails.includes(v.email) && v.email !== AppState.currentUser.email);
            let contentHtml = colleagues.length > 0 ? '<ul style="list-style: none; padding: 0;">' + colleagues.map(v => `<li style="padding: 0.5rem 0;">${v.nome} ${v.cognome}</li>`).join('') + '</ul>' : '<p>Sei l\'unico volontario assegnato a questo turno per ora.</p>';
            renderModal(`Altri Volontari per: ${shift.nome_turno}`, contentHtml);
        }

        function showManageCategoriesModal() {
            let listHtml = AppState.shiftCategories.length > 0 ? AppState.shiftCategories.map(cat => `<div class="category-item"><span>${cat}</span><button class="btn btn-danger delete-category-btn" data-id="${cat}"><i class='bx bx-trash'></i></button></div>`).join('') : `<p>Nessuna categoria creata.</p>`;
            const contentHtml = `<div id="manage-categories-modal-body"><div id="categories-list-modal">${listHtml}</div><form id="add-category-form"><input type="text" id="new-category-name" placeholder="Nome nuova categoria" required><button type="submit" class="btn btn-secondary"><i class='bx bx-plus'></i></button></form></div>`;
            renderModal('Gestisci Categorie', contentHtml, () => {
                document.getElementById('add-category-form').addEventListener('submit', handleAddCategory);
                document.querySelectorAll('.delete-category-btn').forEach(btn => btn.addEventListener('click', (e) => handleDeleteCategory(e.target.closest('button').dataset.id)));
            });
        }

        async function handleAddCategory(e) {
            e.preventDefault();
            const input = document.getElementById('new-category-name');
            const categoryName = input.value.trim();
            if (!categoryName) {
                showToast('Il nome della categoria non può essere vuoto.', 'error');
                return;
            }
            try {
                await setDoc(doc(db, 'shift_categories', categoryName), {});
                showToast('Categoria aggiunta!');
                input.value = '';
            } catch (error) {
                console.error("Errore aggiunta categoria:", error);
                showToast('Errore durante l\'aggiunta della categoria.', 'error');
            }
        }
        
        function handleDeleteCategory(categoryId) {
            showConfirmationModal(`Sei sicuro di voler rimuovere la categoria "${categoryId}"?`, async () => {
                try {
                    await deleteDoc(doc(db, 'shift_categories', categoryId));
                    showToast('Categoria rimossa.');
                    window.closeCurrentModal();
                } catch (error) { console.error("Errore rimozione categoria:", error); showToast('Errore durante la rimozione.', 'error'); }
            });
        }

        function showProfileModal() {
            const { nome, cognome, email, telefono } = AppState.currentUser;
            const currentTheme = document.body.classList.contains('light-theme') ? 'light' : 'dark';
            const content = `<p><strong>Nome:</strong> ${nome} ${cognome}</p><p><strong>Email:</strong> ${email}</p><p><strong>Telefono:</strong> ${telefono}</p><hr style="margin: 1.5rem 0; border-color: var(--border-color);"><div class="theme-switcher"><span>Tema Chiaro</span><label class="switch"><input type="checkbox" id="theme-toggle" ${currentTheme === 'light' ? 'checked' : ''}><span class="slider"></span></label></div><div style="margin-top: 1rem;"><button id="enable-push-btn" class="btn btn-secondary btn-block">Abilita Notifiche Push</button></div><button id="logout-btn" class="btn btn-danger btn-block">Logout</button>`;
            renderModal('Il Mio Profilo', content, () => {
                document.getElementById('logout-btn').addEventListener('click', handleLogout);
                document.getElementById('theme-toggle').addEventListener('change', (e) => {
                    const theme = e.target.checked ? 'light' : 'dark';
                    localStorage.setItem('theme', theme);
                    applyTheme();
                });
                document.getElementById('enable-push-btn').addEventListener('click', enablePushNotifications);
            });
        }
        
        function showVolunteerForm(volunteerId = null) {
            const isEditing = volunteerId !== null;
            const volunteer = isEditing ? AppState.volunteers.find(v => v.id === volunteerId) : {};
            const title = isEditing ? 'Modifica Volontario' : 'Aggiungi Volontario';
            const formHtml = `<form id="volunteer-form"><input type="hidden" id="volunteerId" value="${volunteerId || ''}"><div class="form-group"><label for="nome">Nome</label><input type="text" id="nome" value="${volunteer.nome || ''}" required></div><div class="form-group"><label for="cognome">Cognome</label><input type="text" id="cognome" value="${volunteer.cognome || ''}" required></div><div class="form-group"><label for="email">Email</label><input type="email" id="email" value="${volunteer.email || ''}" ${isEditing ? 'readonly' : ''} required></div><div class="form-group"><label for="telefono">Telefono</label><input type="tel" id="telefono" value="${volunteer.telefono || ''}" required></div><div class="form-group"><label for="ruolo">Ruolo</label><select id="ruolo" required><option value="Volontario" ${volunteer.ruolo === 'Volontario' ? 'selected' : ''}>Volontario</option><option value="Responsabile" ${volunteer.ruolo === 'Responsabile' ? 'selected' : ''}>Responsabile</option><option value="Admin" ${volunteer.ruolo === 'Admin' ? 'selected' : ''}>Admin</option></select></div><button type="submit" class="btn btn-primary btn-block">${isEditing ? 'Salva Modifiche' : 'Aggiungi Volontario'}</button>${isEditing ? '<button type="button" id="delete-volunteer-btn" class="btn btn-danger btn-block">Rimuovi Volontario</button>' : ''}</form>`;
            renderModal(title, formHtml, () => {
                document.getElementById('volunteer-form').addEventListener('submit', handleVolunteerFormSubmit);
                if (isEditing) document.getElementById('delete-volunteer-btn').addEventListener('click', () => handleDeleteVolunteer(volunteerId));
            });
        }
        async function handleVolunteerFormSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const isEditing = !!form.querySelector('#volunteerId').value;
            const data = { nome: form.querySelector('#nome').value, cognome: form.querySelector('#cognome').value, email: form.querySelector('#email').value.toLowerCase(), telefono: form.querySelector('#telefono').value, ruolo: form.querySelector('#ruolo').value };
            if (!data.nome || !data.cognome || !data.email || !data.telefono) { showToast('Tutti i campi sono obbligatori.', 'error'); return; }
            try {
                await setDoc(doc(db, 'volunteers', data.email), data);
                showToast(`Volontario ${isEditing ? 'aggiornato' : 'aggiunto'}!`);
                window.closeCurrentModal();
            } catch (error) { showToast('Errore durante il salvataggio.', 'error'); }
        }
        function handleDeleteVolunteer(volunteerId) {
            showConfirmationModal(`Sei sicuro di voler rimuovere questo volontario? Verranno rimosse anche tutte le sue assegnazioni.`, async () => {
                try {
                    const q = query(assignmentsCol, where('email_volontario', '==', volunteerId));
                    const assignmentsSnapshot = await getDocs(q);
                    const batch = writeBatch(db);
                    assignmentsSnapshot.forEach(doc => batch.delete(doc.ref));
                    await batch.commit();
                    await deleteDoc(doc(db, 'volunteers', volunteerId));
                    showToast('Volontario e assegnazioni rimossi.');
                } catch (error) { showToast('Errore durante la rimozione.', 'error'); }
            });
        }
        function showShiftForm(shiftId = null, category = '') {
            const isEditing = shiftId !== null;
            const shift = isEditing ? AppState.shifts.find(s => s.id === shiftId) : {};
            const title = isEditing ? 'Modifica Turno' : 'Crea Turno';
            const categoryOptions = AppState.shiftCategories.map(cat => `<option value="${cat}" ${isEditing ? (cat === shift.categoria ? 'selected' : '') : (cat === category ? 'selected' : '')}>${cat}</option>`).join('');
            const formHtml = `<form id="shift-form"><input type="hidden" id="shiftId" value="${shiftId || ''}"><div class="form-group"><label for="id_turno">ID Turno (es. ACC-01)</label><input type="text" id="id_turno" value="${shift.id_turno || ''}" required ${isEditing ? 'readonly' : ''}></div><div class="form-group"><label for="categoria">Categoria</label><select id="categoria" required><option value="">Seleziona</option>${categoryOptions}</select></div><div class="form-group"><label for="nome_turno">Nome Turno</label><input type="text" id="nome_turno" value="${shift.nome_turno || ''}" required></div><div class="form-group"><label for="descrizione">Descrizione</label><input type="text" id="descrizione" value="${shift.descrizione || ''}" required></div><div class="form-group"><label for="luogo">Luogo</label><input type="text" id="luogo" value="${shift.luogo || ''}" required></div><div class="form-group"><label for="data_inizio">Data (GG/MM/AAAA)</label><input type="text" id="data_inizio" placeholder="GG/MM/AAAA" value="${shift.data_inizio || ''}" required></div><div class="form-group"><label for="ora_inizio">Ora Inizio (HH:MM)</label><input type="time" id="ora_inizio" value="${shift.ora_inizio || ''}" required></div><div class="form-group"><label for="ora_fine">Ora Fine (HH:MM)</label><input type="time" id="ora_fine" value="${shift.ora_fine || ''}" required></div><button type="submit" class="btn btn-primary btn-block">${isEditing ? 'Salva Modifiche' : 'Crea Turno'}</button>${isEditing ? '<button type="button" id="delete-shift-btn" class="btn btn-danger btn-block">Rimuovi Turno</button>' : ''}</form>`;
            renderModal(title, formHtml, () => {
                document.getElementById('shift-form').addEventListener('submit', handleShiftFormSubmit);
                if (isEditing) document.getElementById('delete-shift-btn').addEventListener('click', () => handleDeleteShift(shiftId));
            });
        }
        async function handleShiftFormSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const shiftId = form.querySelector('#shiftId').value;
            const isEditing = !!shiftId;
            const data = { id_turno: form.querySelector('#id_turno').value, categoria: form.querySelector('#categoria').value, nome_turno: form.querySelector('#nome_turno').value, descrizione: form.querySelector('#descrizione').value, luogo: form.querySelector('#luogo').value, data_inizio: form.querySelector('#data_inizio').value, ora_inizio: form.querySelector('#ora_inizio').value, ora_fine: form.querySelector('#ora_fine').value };
            if (Object.values(data).some(v => !v)) { showToast('Tutti i campi sono obbligatori.', 'error'); return; }
            try {
                const docRef = isEditing ? doc(db, 'shifts', shiftId) : doc(db, 'shifts', data.id_turno);
                await setDoc(docRef, data);
                showToast(`Turno ${isEditing ? 'aggiornato' : 'creato'}!`);
                window.closeCurrentModal();
            } catch (error) { showToast('Errore durante il salvataggio.', 'error'); }
        }
        function handleDeleteShift(shiftId) {
             const shiftToDelete = AppState.shifts.find(s => s.id === shiftId);
             if (!shiftToDelete) return;
             showConfirmationModal(`Sei sicuro di voler rimuovere il turno "${shiftToDelete.nome_turno}"? Verranno rimosse anche tutte le sue assegnazioni.`, async () => {
                try {
                    const q = query(assignmentsCol, where('id_turno', '==', shiftToDelete.id_turno));
                    const assignmentsSnapshot = await getDocs(q);
                    const batch = writeBatch(db);
                    assignmentsSnapshot.forEach(doc => batch.delete(doc.ref));
                    await batch.commit();
                    await deleteDoc(doc(db, 'shifts', shiftId));
                    showToast('Turno e assegnazioni rimossi.');
                } catch (error) { showToast('Errore durante la rimozione.', 'error'); }
             });
        }
        function showVolunteerShiftsModal(volunteerEmail) {
            const volunteer = AppState.volunteers.find(v => v.email === volunteerEmail);
            const assignments = AppState.assignments.filter(a => a.email_volontario === volunteerEmail);
            const shiftIds = assignments.map(a => a.id_turno);
            const shifts = AppState.shifts.filter(s => shiftIds.includes(s.id_turno));
            let contentHtml = shifts.length > 0 ? shifts.map(s => `<div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0;"><span>${s.nome_turno} (${s.data_inizio})</span><button class="btn btn-danger remove-assignment-btn" data-assignment-id="${assignments.find(a => a.id_turno === s.id_turno).id}"><i class='bx bx-trash'></i></button></div>`).join('') : '<p>Nessun turno assegnato.</p>';
            renderModal(`Turni di ${volunteer.nome} ${volunteer.cognome}`, contentHtml, () => {
                document.querySelectorAll('.remove-assignment-btn').forEach(btn => btn.addEventListener('click', (e) => {
                    showConfirmationModal('Rimuovere questa assegnazione?', async () => {
                        try {
                            await deleteDoc(doc(db, 'assignments', e.target.closest('button').dataset.assignmentId));
                            showToast('Assegnazione rimossa.');
                            showVolunteerShiftsModal(volunteerEmail);
                        } catch (error) { showToast('Errore rimozione.', 'error'); }
                    });
                }));
            });
        }
        function showManageVolunteersModal(shiftId) {
            const shift = AppState.shifts.find(s => s.id === shiftId);
            const assignedEmails = new Set(AppState.assignments.filter(a => a.id_turno === shift.id_turno).map(a => a.email_volontario));
            const assigned = AppState.volunteers.filter(v => assignedEmails.has(v.email));
            const available = AppState.volunteers.filter(v => !assignedEmails.has(v.email));
            const contentHtml = `<div><h4>Assegnati</h4><div id="assigned-list" style="margin-bottom: 1.5rem;">${assigned.length > 0 ? assigned.map(v => `<div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0;"><span>${v.nome} ${v.cognome}</span><button class="btn btn-danger unassign-btn" data-email="${v.email}"><i class='bx bx-x'></i></button></div>`).join('') : '<p>Nessuno</p>'}</div><h4>Assegna</h4><form id="assign-form"><div class="form-group">${available.length > 0 ? available.map(v => `<label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.3rem 0;"><input type="checkbox" name="assign-volunteer" value="${v.email}"> ${v.nome} ${v.cognome}</label>`).join('') : '<p>Nessun volontario disponibile.</p>'}</div><button type="submit" class="btn btn-primary btn-block">Assegna</button></form></div>`;
            renderModal(`Gestisci Volontari per: ${shift.nome_turno}`, contentHtml, () => {
                document.querySelectorAll('.unassign-btn').forEach(btn => btn.addEventListener('click', (e) => {
                    showConfirmationModal('Rimuovere l\'assegnazione di questo volontario dal turno?', async () => {
                        const assignment = AppState.assignments.find(a => a.id_turno === shift.id_turno && a.email_volontario === e.target.closest('button').dataset.email);
                        if (assignment) { await deleteDoc(doc(db, 'assignments', assignment.id)); showToast('Assegnazione rimossa'); showManageVolunteersModal(shiftId); }
                    });
                }));
                document.getElementById('assign-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const selected = Array.from(e.target.querySelectorAll('input:checked')).map(cb => cb.value);
                    if (selected.length === 0) return;
                    const batch = writeBatch(db);
                    selected.forEach(email => batch.set(doc(collection(db, 'assignments')), { email_volontario: email, id_turno: shift.id_turno }));
                    await batch.commit();
                    showToast('Volontari assegnati');
                    showManageVolunteersModal(shiftId);
                });
            });
        }
        function showRaceEventForm(eventId = null) {
            const isEditing = eventId !== null;
            const event = isEditing ? AppState.raceEvents.find(e => e.id === eventId) : {};
            const title = isEditing ? 'Modifica Evento' : 'Crea Evento';
            const levels = ['Generale', 'Mini', 'Mini Maschile', 'Mini Femminile', 'Junior', 'Junior Maschile', 'Junior Femminile', 'Senior', 'Senior Maschile', 'Senior Femminile'];
            const levelOpts = levels.map(l => `<option value="${l}" ${isEditing && event.level === l ? 'selected' : ''}>${l}</option>`).join('');
            const sportOpts = Object.keys(SPORT_DETAILS).map(s => `<option value="${s}" ${isEditing && event.eventName === s ? 'selected' : ''}>${s}</option>`).join('');
            const formHtml = `<form id="race-event-form"><input type="hidden" id="raceEventId" value="${eventId || ''}"><div class="form-group"><label for="eventType">Tipologia</label><select id="eventType" required><option value="">Seleziona</option><option value="Sport" ${isEditing && event.tipologia === 'Sport' ? 'selected' : ''}>Sport</option><option value="Generale" ${isEditing && event.tipologia === 'Generale' ? 'selected' : ''}>Generale</option></select></div><div id="eventNameSportContainer" class="form-group ${!isEditing || event.tipologia !== 'Sport' ? 'hidden' : ''}"><label for="eventNameSport">Nome Sport</label><select id="eventNameSport">${sportOpts}</select></div><div id="eventNameGeneralContainer" class="form-group ${!isEditing || event.tipologia !== 'Generale' ? 'hidden' : ''}"><label for="eventNameGeneral">Nome Evento</label><input type="text" id="eventNameGeneral" value="${isEditing && event.tipologia === 'Generale' ? event.eventName : ''}"></div><div class="form-group"><label for="level">Livello</label><select id="level" required>${levelOpts}</select></div><div class="form-group"><label for="location">Luogo</label><input type="text" id="location" value="${event.location || ''}" required></div><div class="form-group"><label for="date">Data (GG/MM/AAAA)</label><input type="text" id="date" placeholder="GG/MM/AAAA" value="${event.date || ''}" required></div><div class="form-group"><label for="startTime">Ora Inizio</label><input type="time" id="startTime" value="${event.startTime || ''}" required></div><div class="form-group"><label for="endTime">Ora Fine</label><input type="time" id="endTime" value="${event.endTime || ''}" required></div><div class="form-group"><label for="description">Descrizione</label><input type="text" id="description" value="${event.description || ''}"></div><button type="submit" class="btn btn-primary btn-block">${isEditing ? 'Salva' : 'Crea'}</button></form>`;
            renderModal(title, formHtml, () => {
                const typeSelect = document.getElementById('eventType');
                const sportCont = document.getElementById('eventNameSportContainer');
                const generalCont = document.getElementById('eventNameGeneralContainer');
                typeSelect.addEventListener('change', () => {
                    sportCont.classList.toggle('hidden', typeSelect.value !== 'Sport');
                    generalCont.classList.toggle('hidden', typeSelect.value !== 'Generale');
                });
                document.getElementById('race-event-form').addEventListener('submit', handleRaceEventFormSubmit);
            });
        }
        async function handleRaceEventFormSubmit(e) {
            e.preventDefault();
            const form = e.target;
            const eventId = form.querySelector('#raceEventId').value;
            const isEditing = !!eventId;
            const tipologia = form.querySelector('#eventType').value;
            let eventName = tipologia === 'Sport' ? form.querySelector('#eventNameSport').value : form.querySelector('#eventNameGeneral').value;
            const data = { tipologia, eventName, level: form.querySelector('#level').value, location: form.querySelector('#location').value, date: form.querySelector('#date').value, startTime: form.querySelector('#startTime').value, endTime: form.querySelector('#endTime').value, description: form.querySelector('#description').value };
            if (!data.tipologia || !data.eventName || !data.location || !data.date || !data.startTime || !data.endTime) { showToast('Tutti i campi obbligatori.', 'error'); return; }
            try {
                if (isEditing) await setDoc(doc(db, 'race_events', eventId), data);
                else await addDoc(raceEventsCol, data);
                showToast(`Evento ${isEditing ? 'aggiornato' : 'creato'}!`);
                window.closeCurrentModal();
            } catch (error) { showToast('Errore nel salvataggio.', 'error'); }
        }
        function handleDeleteRaceEvent(eventId) {
            showConfirmationModal('Sei sicuro di voler eliminare questo evento?', async () => {
                try { await deleteDoc(doc(db, 'race_events', eventId)); showToast('Evento eliminato.'); }
                catch (error) { showToast('Errore durante l\'eliminazione.', 'error'); }
            });
        }
        
        // ====================================================================
        // NUOVE FUNZIONI NOTIFICHE
        // ====================================================================
        async function enablePushNotifications() {
            if (!('serviceWorker' in navigator) || !('PushManager' in window)) {
                showToast('Notifiche Push non supportate da questo browser.', 'error');
                return;
            }

            try {
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    showToast('Permesso per le notifiche concesso!', 'success');
                    // Qui andrebbe la logica per ottenere la sottoscrizione e salvarla.
                    // Per ora, ci limitiamo a confermare che il permesso è stato dato.
                    const registration = await navigator.serviceWorker.ready;
                    console.log('Service Worker pronto per le notifiche push.', registration);
                } else {
                    showToast('Permesso per le notifiche non concesso.', 'error');
                }
            } catch (error) {
                console.error('Errore durante l\'abilitazione delle notifiche push:', error);
                showToast('Errore durante l\'abilitazione delle notifiche.', 'error');
            }
        }

        function updateNotificationBell() {
            const badge = notificationsBtn.querySelector('.notification-badge');
            if (AppState.unreadCount > 0) {
                badge.textContent = AppState.unreadCount;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        function showNotificationsPanel() {
            const isAdmin = AppState.currentUser.ruolo === 'Admin' || AppState.currentUser.ruolo === 'Responsabile';
            
            const notificationsHtml = AppState.notifications.length > 0
                ? '<ul id="notification-list">' + AppState.notifications.map(n => {
                    const isUnread = !n.readBy.includes(AppState.currentUser.email);
                    const date = n.timestamp?.toDate().toLocaleString('it-IT', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' }) || '';
                    return `
                        <li class="notification-item ${isUnread ? 'unread' : ''}" data-id="${n.id}">
                            <div class="notification-content">
                                <p>${n.message}</p>
                                <div class="meta">Da: ${n.sender} &bull; ${date}</div>
                            </div>
                            <i class='bx bx-trash delete-notification-btn'></i>
                        </li>`;
                }).join('') + '</ul>'
                : '<p style="padding: 1rem; text-align: center;">Nessuna notifica.</p>';
            
            const adminActionsHtml = isAdmin ? `
                <div class="notification-panel-actions">
                    <button id="send-new-notification-btn" class="btn btn-primary">Invia Nuova</button>
                    <button id="clear-all-notifications-btn" class="btn btn-danger">Pulisci Tutte</button>
                </div>
            ` : '';

            renderModal('Notifiche', notificationsHtml + adminActionsHtml, () => {
                document.getElementById('notification-list')?.addEventListener('click', e => {
                    const deleteBtn = e.target.closest('.delete-notification-btn');
                    const item = e.target.closest('.notification-item');

                    if (deleteBtn) {
                        e.stopPropagation();
                        handleDeleteNotification(item.dataset.id);
                    } else if (item && item.classList.contains('unread')) {
                        markNotificationAsRead(item.dataset.id);
                    }
                });

                if(isAdmin) {
                    document.getElementById('send-new-notification-btn').addEventListener('click', showSendNotificationModal);
                    document.getElementById('clear-all-notifications-btn').addEventListener('click', handleClearAllNotifications);
                }
            });
        }

        async function markNotificationAsRead(notificationId) {
            const notifRef = doc(db, 'notifications', notificationId);
            try {
                await updateDoc(notifRef, {
                    readBy: arrayUnion(AppState.currentUser.email)
                });
            } catch (error) {
                console.error("Errore nel segnare la notifica come letta:", error);
            }
        }
        
        function handleDeleteNotification(notificationId) {
            showConfirmationModal('Sei sicuro di voler nascondere questa notifica?', async () => {
                const notifRef = doc(db, 'notifications', notificationId);
                try {
                    await updateDoc(notifRef, {
                        deletedBy: arrayUnion(AppState.currentUser.email)
                    });
                    showToast('Notifica nascosta.');
                    window.closeCurrentModal();
                    setTimeout(showNotificationsPanel, 350);
                } catch (error) {
                    console.error("Errore nel nascondere la notifica:", error);
                    showToast('Errore durante l\'operazione.', 'error');
                }
            });
        }

        function handleClearAllNotifications() {
            showConfirmationModal('Sei sicuro di voler archiviare TUTTE le notifiche per TUTTI gli utenti? Questa azione è consigliata solo per pulizia e non può essere annullata.', async () => {
                const allVolunteerEmails = AppState.volunteers.map(v => v.email);
                if(allVolunteerEmails.length === 0) {
                    window.closeCurrentModal();
                    return;
                }

                const batch = writeBatch(db);
                const notificationsSnapshot = await getDocs(notificationsCol);
                notificationsSnapshot.forEach(doc => {
                    const notifRef = doc.ref;
                    batch.update(notifRef, { deletedBy: allVolunteerEmails });
                });
                
                try {
                    await batch.commit();
                    showToast('Tutte le notifiche sono state archiviate.');
                    window.closeCurrentModal();
                } catch (error) {
                    console.error("Errore archiviazione notifiche:", error);
                    showToast('Errore durante l\'archiviazione.', 'error');
                }
            });
        }


        function showSendNotificationModal() {
            const closeCurrent = window.closeCurrentModal;
            if(closeCurrent) {
                closeCurrent();
            }

            setTimeout(() => {
                const shiftOptions = AppState.shifts.map(s => `<option value="${s.id_turno}">${s.nome_turno} (${s.data_inizio})</option>`).join('');
                const formHtml = `
                    <form id="send-notification-form">
                        <div class="form-group">
                            <label for="notification-message">Messaggio</label>
                            <textarea id="notification-message" required></textarea>
                        </div>
                        <div class="form-group">
                            <label for="notification-recipient">Destinatario</label>
                            <select id="notification-recipient" required>
                                <option value="all">Tutti i volontari</option>
                                <option value="shift">Un turno specifico</option>
                            </select>
                        </div>
                        <div class="form-group hidden" id="shift-selector-container">
                            <label for="notification-shift">Seleziona Turno</label>
                            <select id="notification-shift">
                                ${shiftOptions}
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary btn-block">Invia Notifica</button>
                    </form>
                `;
                renderModal('Invia Notifica', formHtml, () => {
                    const recipientSelect = document.getElementById('notification-recipient');
                    const shiftSelector = document.getElementById('shift-selector-container');
                    recipientSelect.addEventListener('change', () => {
                        shiftSelector.classList.toggle('hidden', recipientSelect.value !== 'shift');
                    });
                    document.getElementById('send-notification-form').addEventListener('submit', handleSendNotification);
                });
            }, 350);
        }

        async function handleSendNotification(e) {
            e.preventDefault();
            const message = document.getElementById('notification-message').value.trim();
            if (!message) {
                showToast('Il messaggio non può essere vuoto.', 'error');
                return;
            }

            const recipientType = document.getElementById('notification-recipient').value;
            let targetEmails = [];

            if (recipientType === 'all') {
                targetEmails = AppState.volunteers.map(v => v.email);
            } else {
                const shiftId = document.getElementById('notification-shift').value;
                if (!shiftId) {
                    showToast('Seleziona un turno.', 'error');
                    return;
                }
                targetEmails = AppState.assignments
                    .filter(a => a.id_turno === shiftId)
                    .map(a => a.email_volontario);
            }
            
            if (targetEmails.length === 0) {
                showToast('Nessun destinatario trovato per questa selezione.', 'error');
                return;
            }

            try {
                await addDoc(notificationsCol, {
                    message: message,
                    sender: `${AppState.currentUser.nome} ${AppState.currentUser.cognome}`,
                    timestamp: serverTimestamp(),
                    targetEmails: targetEmails,
                    readBy: [],
                    deletedBy: []
                });
                showToast('Notifica inviata con successo!', 'success');
                window.closeCurrentModal();
            } catch (error) {
                console.error("Errore invio notifica:", error);
                showToast('Errore durante l\'invio.', 'error');
            }
        }

        // ====================================================================
        // INIZIO APPLICAZIONE
        // ====================================================================
        function init() {
            // Registra il Service Worker
            if ('serviceWorker' in navigator) {
                const swScriptElement = document.getElementById('sw-script');
                if (swScriptElement) {
                    const swScriptContent = swScriptElement.textContent;
                    const swBlob = new Blob([swScriptContent], { type: 'application/javascript' });
                    const swUrl = URL.createObjectURL(swBlob);
                    navigator.serviceWorker.register(swUrl)
                        .then(registration => console.log('Service Worker registrato con successo:', registration))
                        .catch(error => console.error('Registrazione Service Worker fallita:', error));
                }
            }

            // Aggiunge il link al manifest dinamicamente
            const manifestLink = document.getElementById('manifest');
            const manifestContent = `{
              "name": "Gestione Volontari",
              "short_name": "Volontari",
              "start_url": ".",
              "display": "standalone",
              "background_color": "#001f2b",
              "theme_color": "#001f2b",
              "description": "App per la gestione dei volontari e dei turni.",
              "icons": [
                {
                  "src": "https://placehold.co/192x192/001f2b/ffffff?text=GV",
                  "sizes": "192x192",
                  "type": "image/png"
                },
                {
                  "src": "https://placehold.co/512x512/001f2b/ffffff?text=GV",
                  "sizes": "512x512",
                  "type": "image/png"
                }
              ]
            }`;
            const blob = new Blob([manifestContent], { type: 'application/json' });
            manifestLink.href = URL.createObjectURL(blob);


            applyTheme();
            loginForm.addEventListener('submit', handleLogin);
            onAuthStateChanged(auth, (user) => {
                if(user) checkSession();
            });
        }

        init();
    </script>
</body>
</html>
